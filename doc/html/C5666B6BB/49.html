<!DOCTYPE html><html><head><meta charset="utf-8"><title>haskell-jp / questions #49</title><link rel="stylesheet" href="/messages.css" type="text/css" media="screen"></head><body><h1>haskell-jp / questions #49</h1><div class="pager"><a href="/html/C5666B6BB/48.html" class="pager__previous">Previous</a><a href="/" class="pager__top">Top</a><a href="/html/C5666B6BB/50.html" class="pager__next">Next</a></div><div class="message_list"><div class="message" id="message-1551860438.113300"><div class="message__timestamp">2019-03-06<br/>17:20:38 +0900</div><div class="message__header">cutsea110</div><div class="message__body">あとLLVMも<br/><a href='https://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/Backends/LLVM/Installing'>https://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/Backends/LLVM/Installing</a><br/>これみるとGHC 8.4系だとLLVM5.0なんですね.<br/>最初LLVM7.0が入ったときにビルド時にwarnning出て,6.0にdowngradeしたら黙ったから気付かなかったけど</div></div><div class="message" id="message-1551860545.113500"><div class="message__timestamp">2019-03-06<br/>17:22:25 +0900</div><div class="message__header">cutsea110</div><div class="message__body">だがapt searchしても見当らないのであった.</div></div><div class="message" id="message-1551860639.113700"><div class="message__timestamp">2019-03-06<br/>17:23:59 +0900</div><div class="message__header">cutsea110</div><div class="message__body">and u zlib!!!</div></div><div class="message" id="message-1551860647.113900"><div class="message__timestamp">2019-03-06<br/>17:24:07 +0900</div><div class="message__header">cutsea110</div><div class="message__body">sudo apt install libghc-zlib-prof</div></div><div class="message" id="message-1551860723.114100"><div class="message__timestamp">2019-03-06<br/>17:25:23 +0900</div><div class="message__header">cutsea110</div><div class="message__body">うーんまたこうしてaptで入れているのとcabal で入れているのがgotchaになっていく.</div></div><div class="message" id="message-1551860764.114300"><div class="message__timestamp">2019-03-06<br/>17:26:04 +0900</div><div class="message__header">autotaker</div><div class="message__body"><code>ghc</code>のバイナリインストールなら最近は <code>ghcup</code>がオススメです.</div></div><div class="message" id="message-1551860796.114500"><div class="message__timestamp">2019-03-06<br/>17:26:36 +0900</div><div class="message__header">cutsea110</div><div class="message__body">初耳 <blockquote>ghcup</blockquote></div></div><div class="message" id="message-1551860918.114700"><div class="message__timestamp">2019-03-06<br/>17:28:38 +0900</div><div class="message__header">cutsea110</div><div class="message__body">祝コンパイル成功!!</div></div><div class="message" id="message-1551860952.114900"><div class="message__timestamp">2019-03-06<br/>17:29:12 +0900</div><div class="message__header">cutsea110</div><div class="message__body">まだスタートライン100メートル手前の心境.</div></div><div class="message" id="message-1551861053.115100"><div class="message__timestamp">2019-03-06<br/>17:30:53 +0900</div><div class="message__header">cutsea110</div><div class="message__body">cabal new-exec main -- +RTS -p -N8 -smain.log<br/><br/>が起動したので涙でモニタが見えない.</div></div><div class="message" id="message-1551861116.115300"><div class="message__timestamp">2019-03-06<br/>17:31:56 +0900</div><div class="message__header">cutsea110</div><div class="message__body">この顛末をqiitaに残すべきかどうか</div></div><div class="message" id="message-1551861319.115500"><div class="message__timestamp">2019-03-06<br/>17:35:19 +0900</div><div class="message__header">cutsea110</div><div class="message__body">こんな状態.</div></div><div class="message" id="message-1551861527.115900"><div class="message__timestamp">2019-03-06<br/>17:38:47 +0900</div><div class="message__header">cutsea110</div><div class="message__body">yesodやってたころは最終的に必要になったからstack使ったけど今はもっぱらcabalしか使ってないです.</div></div><div class="message" id="message-1551863040.120000"><div class="message__timestamp">2019-03-06<br/>18:04:00 +0900</div><div class="message__header">a_kirisaki</div><div class="message__body"><code>[Network.Simple.TCP.TLS](<http://hackage.haskell.org/package/network-simple-tls-0.3.1/docs/Network-Simple-TCP-TLS.html>)</code>というパッケージで以下のようなコードを実行させてchromeでhttpsでアクセスするとスレッドが残ったままになってしまいます（Firefox、Safariでは起こらない）。<br/><pre>
{-# LANGUAGE LambdaCase        #-}
{-# LANGUAGE OverloadedStrings #-}

module Lib
    ( someFunc
    ) where

import           Control.Concurrent
import           Control.Monad
import           Data.X509.CertificateStore
import           Network.Simple.TCP.TLS
import           Network.TLS

someFunc :: IO ()
someFunc = do
  credentialLoadX509 "./localhost.pem" "./localhost-key.pem" &gt;&gt;=
    \case
      Right c -&gt;
        void $ forkIO $ serve (makeServerSettings c Nothing) "localhost" "8080" $ \(ctx, _) -&gt; establish ctx
      _ -&gt;
        putStrLn "Error"
  -- 終了させないためだけの処理
  _ &lt;- getLine
  pure ()

establish :: Context -&gt; IO ()
establish ctx = do
  r &lt;- recv ctx
  case r of
    Just r' -&gt; print r'
    _       -&gt; pure ()
</pre><br/>[このあたり](<https://github.com/k0001/network-simple-tls/blob/68a152e8e834ed3e0b5f5cac9d60927df385e682/src/Network/Simple/TCP/TLS.hs#L537-L543>)の例外ハンドリングがまずってるんじゃないかと同僚と推測しているのですが、何かお心当たりありませんか</div></div><div class="message" id="message-1551863380.120300"><div class="message__timestamp">2019-03-06<br/>18:09:40 +0900</div><div class="message__header">hexirp</div><div class="message__body">今更 ghc と runghc を混同していたのに気が付きました。今まで ghc として示していた結果は runghc のです。 ghc での結果はこれです（一定）。<br/><pre>
0
MyI# 0#
IBI# 0#
1729382256910270464
MyI# 1729382256910270464#
CB
10
CB
CA
CA
</pre></div></div><div class="message" id="message-1551863874.120500"><div class="message__timestamp">2019-03-06<br/>18:17:54 +0900</div><div class="message__header">cutsea110</div><div class="message__body">無事profile採取できました.<br/>ありがとうございました.</div></div><div class="message" id="message-1551865289.120900"><div class="message__timestamp">2019-03-06<br/>18:41:29 +0900</div><div class="message__header">buddha0818</div><div class="message__body">@buddha0818 has joined the channel</div></div><div class="message" id="message-1551875626.121600"><div class="message__timestamp">2019-03-06<br/>21:33:46 +0900</div><div class="message__header">takashi.mtsd</div><div class="message__body">@takashi.mtsd has joined the channel</div></div><div class="message" id="message-1551878632.121800"><div class="message__timestamp">2019-03-06<br/>22:23:52 +0900</div><div class="message__header">takenobu.hs</div><div class="message__body"><blockquote>+9 （アラインメントしていない場所）からの8バイト、というのがすごく気持ち悪いです… intel だから読めるけどそれ以外のアーキテクチャだったらアラインメントエラーになるのでは、という感が</blockquote><br/>そうなんですよね、「+9」は気持ち悪いです。<br/>正しいInt型のコードだと、payloadのInt値を読み取る箇所は、「+8」のコードを正しく吐いていました。ところが、unsafeCoerceで無理矢理に型をひねると、Cmm出力の時点でコードが「+9」を指すように変わりました。（ただ、非保証動作で深そうなので、コード生成のどこで不整合が起きているかは、それ以上追いませんでした ^^;）</div></div><div class="message" id="message-1551939979.122600"><div class="message__timestamp">2019-03-07<br/>15:26:19 +0900</div><div class="message__header">hiroto.shioi</div><div class="message__body">stylish-haskellに関する質問です。<br/>指定したディレクトリ内の.hsファイルすべてにstylish-haskellを適用するコマンドってありますか？<br/>src内のhaskellモジュールが結構な数になったので一気に適用できればいいなーと考えたのです。</div></div><div class="message" id="message-1551940517.122700"><div class="message__timestamp">2019-03-07<br/>15:35:17 +0900</div><div class="message__header">koyama</div><div class="message__body"><a href='http://manpages.ubuntu.com/manpages/bionic/man1/stylish-haskell.1.html'>http://manpages.ubuntu.com/manpages/bionic/man1/stylish-haskell.1.html</a> これでしょうか？<br/>--inplace オプションを指定してワイルドカードで複数ファイルを指定すればよさそうですが…。</div></div><div class="message" id="message-1551940525.122900"><div class="message__timestamp">2019-03-07<br/>15:35:25 +0900</div><div class="message__header">matsubara0507</div><div class="message__body"><a href='https://haskell.e-bigmoon.com/stack/etc/stylish-haskell.html'>https://haskell.e-bigmoon.com/stack/etc/stylish-haskell.html</a><br/>にワンライナーが載ってる</div></div><div class="message" id="message-1551940542.123200"><div class="message__timestamp">2019-03-07<br/>15:35:42 +0900</div><div class="message__header">matsubara0507</div><div class="message__body">実は正しいオプションがあるかもだけど</div></div><div class="message" id="message-1551940567.123400"><div class="message__timestamp">2019-03-07<br/>15:36:07 +0900</div><div class="message__header">koyama</div><div class="message__body">上記ワンライナーも -i オプション(--inplace の短縮形)使ってるようですね</div></div><div class="message" id="message-1551940585.123600"><div class="message__timestamp">2019-03-07<br/>15:36:25 +0900</div><div class="message__header">koyama</div><div class="message__body">ワイルドカードの代わりに find の結果を使ってるだけのようです</div></div><div class="message" id="message-1551940713.123900"><div class="message__timestamp">2019-03-07<br/>15:38:33 +0900</div><div class="message__header">a_kirisaki</div><div class="message__body">自己解決しました。このプルリクエストが解決策でした <a href='https://github.com/k0001/network-simple-tls/pull/13'>https://github.com/k0001/network-simple-tls/pull/13</a></div></div><div class="message" id="message-1551940766.124200"><div class="message__timestamp">2019-03-07<br/>15:39:26 +0900</div><div class="message__header">hiroto.shioi</div><div class="message__body">ありがとうございます！神は存在した！</div></div><div class="message" id="message-1551940905.124400"><div class="message__timestamp">2019-03-07<br/>15:41:45 +0900</div><div class="message__header">koyama</div><div class="message__body">find の方を使う場合は、ファイル名やディレクトリ名に特殊な文字（空白や引用符など）が含まれているとあのままでは動かないことにご注意ください</div></div><div class="message" id="message-1551941020.124600"><div class="message__timestamp">2019-03-07<br/>15:43:40 +0900</div><div class="message__header">koyama</div><div class="message__body"><code>find . -type f -name "*hs" …その他の絞り込み条件…  -print0 | xargs -0 stylish-haskell -i</code> のように find の -print0 オプションと xargs の -0 オプションのコンボを使うとどんな変な文字が含まれていても大丈夫になります</div></div><div class="message" id="message-1551941639.124900"><div class="message__timestamp">2019-03-07<br/>15:53:59 +0900</div><div class="message__header">hiroto.shioi</div><div class="message__body"><code>find . -type f -name "*hs" -not -path '.git' -not -path '*.stack-work*' -print0 | xargs -0 stylish-haskell -i</code><br/>こんな感じ？</div></div><div class="message" id="message-1551941816.125100"><div class="message__timestamp">2019-03-07<br/>15:56:56 +0900</div><div class="message__header">koyama</div><div class="message__body">もとのワンライナーの通りならそうですね</div></div><div class="message" id="message-1551941848.125300"><div class="message__timestamp">2019-03-07<br/>15:57:28 +0900</div><div class="message__header">hiroto.shioi</div><div class="message__body">なるほど！ではこっちを使ってみます。ありがとうー</div></div><div class="message" id="message-1551941971.125500"><div class="message__timestamp">2019-03-07<br/>15:59:31 +0900</div><div class="message__header">koyama</div><div class="message__body">(シェルが zsh なら <code>stylish-haskell -i **/*.hs</code> だけで行けるんですけどね^^;)</div></div><div class="message" id="message-1551949470.126000"><div class="message__timestamp">2019-03-07<br/>18:04:30 +0900</div><div class="message__header">dyoshikawa1993</div><div class="message__body">@dyoshikawa1993 has joined the channel</div></div><div class="message" id="message-1551949902.128200"><div class="message__timestamp">2019-03-07<br/>18:11:42 +0900</div><div class="message__header">as_capabl</div><div class="message__body">git管理しているならfindよりgit ls-files|egrep hs¥$の方が安全という説も</div></div><div class="message" id="message-1551950550.129200"><div class="message__timestamp">2019-03-07<br/>18:22:30 +0900</div><div class="message__header">mizunashi-mana</div><div class="message__body">ライブラリのビルド時に使われた GHC の settings の情報 (<https://gitlab.haskell.org/ghc/ghc/blob/master/settings.in>) を取れるモジュールとかってありますか？</div></div><div class="message" id="message-1551951029.129900"><div class="message__timestamp">2019-03-07<br/>18:30:29 +0900</div><div class="message__header">cutsea110</div><div class="message__body">NOINLINEプラグマって必ずインライン化を抑制するわけではないのでしょうか?</div></div><div class="message" id="message-1551951250.130800"><div class="message__timestamp">2019-03-07<br/>18:34:10 +0900</div><div class="message__header">cutsea110</div><div class="message__body">The NOINLINE pragma does exactly what you’d expect: it stops the named function from being inlined by the compiler. You shouldn’t ever need to do this, unless you’re very cautious about code size.</div></div><div class="message" id="message-1551951346.132700"><div class="message__timestamp">2019-03-07<br/>18:35:46 +0900</div><div class="message__header">cutsea110</div><div class="message__body">とあるんだけど,私の手元で-ddump-simpl-statsを見る限り,-Oを付けるとそうでもないような.</div></div><div class="message" id="message-1551951471.134900"><div class="message__timestamp">2019-03-07<br/>18:37:51 +0900</div><div class="message__header">cutsea110</div><div class="message__body">小さいコード片なのでINLINEプラグマは正直関係なく,-Oを付けようが付けまいがそれなりにやってくれてそうだけど,NOINLINE付けたときに-Oでビルドすると一番激しく(Grand total simplifier statisticsが大きく,しかも生成されたコードも一番良さげみ見受ける)最適化が走っているような</div></div><div class="message" id="message-1551951607.135000"><div class="message__timestamp">2019-03-07<br/>18:40:07 +0900</div><div class="message__header">cutsea110</div><div class="message__body">今試しているコードはこれですが,</div></div><div class="message" id="message-1551951811.135800"><div class="message__timestamp">2019-03-07<br/>18:43:31 +0900</div><div class="message__header">cutsea110</div><div class="message__body">プラグマをはずしてから-Oも付けずにddumpすると,<br/><pre>
==================== Grand total simplifier statistics ====================
Total ticks:     15

6 PreInlineUnconditionally
  2 x
  2 x
  2 y
1 PostInlineUnconditionally 1 x'
2 UnfoldingDone 2 timesInt
1 LetFloatFromLet 1
4 BetaReduction
  2 x
  2 y
1 KnownBranch 1 wild
3 SimplifierDone 3

:
:
==================== CorePrep ====================
Result size of CorePrep
  = {terms: 53, types: 26, coercions: 0, joins: 0/0}

-- RHS size: {terms: 15, types: 7, coercions: 0, joins: 0/0}
timesInt :: Int -&gt; Int -&gt; Int
timesInt
  = \ (x :: Int) (y :: Int) -&gt;
      case x of { I# x' -&gt;
      case y of { I# y' -&gt; case *# x' y' of sat { __DEFAULT -&gt; I# sat } }
      }

-- RHS size: {terms: 22, types: 9, coercions: 0, joins: 0/0}
cube :: Int -&gt; Int
cube
  = \ (x :: Int) -&gt;
      case x of wild { I# x' -&gt;
      case wild of wild1 { I# y' -&gt;
      case wild1 of { I# y'1 -&gt;
      case *# x' y' of sat { __DEFAULT -&gt;
      case *# sat y'1 of sat { __DEFAULT -&gt; I# sat }
      }
      }
      }
      }
</pre></div></div><div class="message" id="message-1551951881.136400"><div class="message__timestamp">2019-03-07<br/>18:44:41 +0900</div><div class="message__header">cutsea110</div><div class="message__body">プラグマを付けずに-Oを付けると<br/><pre>
==================== Grand total simplifier statistics ====================
Total ticks:     17

4 PreInlineUnconditionally
  2 x
  2 y
3 PostInlineUnconditionally
  2 y'
  1 x'
2 UnfoldingDone 2 timesInt
1 LetFloatFromLet 1
4 BetaReduction
  2 x
  2 y
3 KnownBranch
  2 wild
  1 wild
9 SimplifierDone 9

:
:
==================== CorePrep ====================
Result size of CorePrep
  = {terms: 47, types: 22, coercions: 0, joins: 0/0}

-- RHS size: {terms: 15, types: 7, coercions: 0, joins: 0/0}
timesInt :: Int -&gt; Int -&gt; Int
timesInt
  = \ (x :: Int) (y :: Int) -&gt;
      case x of { I# x' -&gt;
      case y of { I# y' -&gt; case *# x' y' of sat { __DEFAULT -&gt; I# sat } }
      }

-- RHS size: {terms: 16, types: 5, coercions: 0, joins: 0/0}
cube :: Int -&gt; Int
cube
  = \ (x :: Int) -&gt;
      case x of { I# x' -&gt;
      case *# x' x' of sat { __DEFAULT -&gt;
      case *# sat x' of sat { __DEFAULT -&gt; I# sat }
      }
      }
</pre></div></div><div class="message" id="message-1551951959.137400"><div class="message__timestamp">2019-03-07<br/>18:45:59 +0900</div><div class="message__header">cutsea110</div><div class="message__body">上のコードのようにNOINLINEを付けて-Oを付けなければ<br/><pre>
==================== Grand total simplifier statistics ====================
Total ticks:     1

1 LetFloatFromLet 1
2 SimplifierDone 2

:
:
==================== CorePrep ====================
Result size of CorePrep
  = {terms: 39, types: 19, coercions: 0, joins: 0/1}

-- RHS size: {terms: 15, types: 7, coercions: 0, joins: 0/0}
timesInt :: Int -&gt; Int -&gt; Int
timesInt
  = \ (x :: Int) (y :: Int) -&gt;
      case x of { I# x' -&gt;
      case y of { I# y' -&gt; case *# x' y' of sat { __DEFAULT -&gt; I# sat } }
      }

-- RHS size: {terms: 8, types: 2, coercions: 0, joins: 0/1}
cube :: Int -&gt; Int
cube
  = \ (x :: Int) -&gt;
      let {
        sat :: Int
        sat = timesInt x x } in
      timesInt sat x
</pre></div></div><div class="message" id="message-1551952084.138400"><div class="message__timestamp">2019-03-07<br/>18:48:04 +0900</div><div class="message__header">cutsea110</div><div class="message__body">最後にNOINLINEが付いてて-Oも指定したら<br/><pre>
==================== Grand total simplifier statistics ====================
Total ticks:     28

8 PreInlineUnconditionally
  3 w
  3 w
  1 x
  1 y
6 PostInlineUnconditionally
  2 ww
  1 x'
  1 y'
  1 ww
  1 ww
2 UnfoldingDone 2 timesInt
1 LetFloatFromLet 1
1 EtaReduction 1 ww
4 BetaReduction
  2 w
  2 w
6 KnownBranch
  2 ww
  1 wild
  1 wild
  1 ww
  1 ww
9 SimplifierDone 9

:
:
==================== CorePrep ====================
Result size of CorePrep
  = {terms: 53, types: 27, coercions: 0, joins: 0/0}

-- RHS size: {terms: 5, types: 2, coercions: 0, joins: 0/0}
$wtimesInt :: Int# -&gt; Int# -&gt; Int#
$wtimesInt = \ (eta :: Int#) (eta :: Int#) -&gt; *# eta eta

-- RHS size: {terms: 15, types: 7, coercions: 0, joins: 0/0}
timesInt :: Int -&gt; Int -&gt; Int
timesInt
  = \ (w :: Int) (w1 :: Int) -&gt;
      case w of { I# ww1 -&gt;
      case w1 of { I# ww3 -&gt;
      case $wtimesInt ww1 ww3 of ww4 { __DEFAULT -&gt; I# ww4 }
      }
      }

-- RHS size: {terms: 16, types: 5, coercions: 0, joins: 0/0}
cube :: Int -&gt; Int
cube
  = \ (x :: Int) -&gt;
      case x of { I# ww1 -&gt;
      case $wtimesInt ww1 ww1 of ww2 { __DEFAULT -&gt;
      case $wtimesInt ww2 ww1 of ww3 { __DEFAULT -&gt; I# ww3 }
      }
      }
</pre><br/>これworker/wrapper変換かかってませんか?</div></div><div class="message" id="message-1551952746.138700"><div class="message__timestamp">2019-03-07<br/>18:59:06 +0900</div><div class="message__header">cutsea110</div><div class="message__body"><a href='http://hackage.haskell.org/package/ghc-8.6.1/docs/HscTypes.html'>http://hackage.haskell.org/package/ghc-8.6.1/docs/HscTypes.html</a><br/>これとかのことですかね.<br/>やったことないけど.</div></div><div class="message" id="message-1551953006.138900"><div class="message__timestamp">2019-03-07<br/>19:03:26 +0900</div><div class="message__header">mizunashi-mana</div><div class="message__body">すいません，これって HscEnv のことですか？ ビルド時の情報を取得する API 見つけられないんですが，どれのことでしょう？</div></div><div class="message" id="message-1551953109.139100"><div class="message__timestamp">2019-03-07<br/>19:05:09 +0900</div><div class="message__header">mizunashi-mana</div><div class="message__body">これな気がしますね．別にそこまでコードが肥大化してるわけではないと思いますが (worker には NOINLINE がつくようなので)， w/w が入ると問題となるコードとかはあるのでしょうか？ あるのでしたら， GHC Trac に投げてみると良いかもしれませんが<br/><a href='https://gitlab.haskell.org/ghc/ghc/blob/ghc-8.6.4-release/compiler/stranal/WorkWrap.hs#L204'>https://gitlab.haskell.org/ghc/ghc/blob/ghc-8.6.4-release/compiler/stranal/WorkWrap.hs#L204</a></div></div><div class="message" id="message-1551953414.139500"><div class="message__timestamp">2019-03-07<br/>19:10:14 +0900</div><div class="message__header">cutsea110</div><div class="message__body">DynFlagsの中とかがそうかなと思って見ているところですが違うかな</div></div><div class="message" id="message-1551953693.139700"><div class="message__timestamp">2019-03-07<br/>19:14:53 +0900</div><div class="message__header">mizunashi-mana</div><div class="message__body">あ，えっと取りたい構造自体は <a href='https://hackage.haskell.org/package/ghc-8.2.1/docs/DynFlags.html#t:Settings'>https://hackage.haskell.org/package/ghc-8.2.1/docs/DynFlags.html#t:Settings</a> の中の sRawSettings に入り，ライブラリのビルド時にそれが使用されることは分かっているのですが，そのライブラリの実行時にその情報を読めるような API はあるのかなというのが，質問です．</div></div></div><div class="pager"><a href="/html/C5666B6BB/48.html" class="pager__previous">Previous</a><a href="/" class="pager__top">Top</a><a href="/html/C5666B6BB/50.html" class="pager__next">Next</a></div></body></html>