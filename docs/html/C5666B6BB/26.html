<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>haskell-jp / questions #26</title>
<link rel="stylesheet" href="../../main.css" type="text/css" media="screen">
</head>
<body>
  <div class="ui container">
    <h1>haskell-jp / questions #26</h1>
    <div class="ui pagination menu">
      <a href="../../html/C5666B6BB/25.html" class="item">Previous</a>
      <a href="../../" class="item">Top</a>
      <a href="../../html/C5666B6BB/27.html" class="item">Next</a>
    </div>
    <div class="ui feed">
      <div class="event" id="message-1533535227.000045">
        <div class="content">
          <div class="summary">
            <div class="user"></div>
            <div class="date"><a class="date" href="#message-1533535227.000045">2018-08-06 15:00:27 +0900</a></div>
          </div>
          <div class="description"><a href='https://github.com/alanz/vscode-hie-server/blob/master/package.json#L100'>https://github.com/alanz/vscode-hie-server/blob/master/package.json#L100</a><br/><a href='https://github.com/alanz/vscode-hie-server/blob/master/src/extension.ts#L153'>https://github.com/alanz/vscode-hie-server/blob/master/src/extension.ts#L153</a><br/><a href='https://github.com/haskell/haskell-ide-engine/blob/master/src/Haskell/Ide/Engine/Options.hs#L23'>https://github.com/haskell/haskell-ide-engine/blob/master/src/Haskell/Ide/Engine/Options.hs#L23</a><br/><br/>たぶんデバッグログだと思うんですけど、使ったことないので自信ないです。</div>
        </div>
      </div>
      <div class="event" id="message-1533535431.000030">
        <div class="content">
          <div class="summary">
            <div class="user">igrep</div>
            <div class="date"><a class="date" href="#message-1533535431.000030">2018-08-06 15:03:51 +0900</a></div>
          </div>
          <div class="description">なるほど。その <code>logLevel</code> 定数のありかが気になってました。<br/>一時ディレクトリーにログを書き込むってことか。</div>
        </div>
      </div>
      <div class="event" id="message-1533704512.000189">
        <div class="content">
          <div class="summary">
            <div class="user">Cosmia</div>
            <div class="date"><a class="date" href="#message-1533704512.000189">2018-08-08 14:01:52 +0900</a></div>
          </div>
          <div class="description">Kan extension は何か具体的な用途や例などあるの？<br/>最近 Kan extensionを勉強して、なんとか理解できたけど、実際の用途は全然思いつかなくて…</div>
        </div>
      </div>
      <div class="event" id="message-1533710149.000089">
        <div class="content">
          <div class="summary">
            <div class="user">1to100pen</div>
            <div class="date"><a class="date" href="#message-1533710149.000089">2018-08-08 15:35:49 +0900</a></div>
          </div>
          <div class="description">Codensity Monad の理論的背景とか <a href='http://myuon-myon.hatenablog.com/entry/2014/11/03/183032'>http://myuon-myon.hatenablog.com/entry/2014/11/03/183032</a></div>
        </div>
      </div>
      <div class="event" id="message-1533714380.000073">
        <div class="content">
          <div class="summary">
            <div class="user">Cosmia</div>
            <div class="date"><a class="date" href="#message-1533714380.000073">2018-08-08 16:46:20 +0900</a></div>
          </div>
          <div class="description">ありがとうございます。</div>
        </div>
      </div>
      <div class="event" id="message-1533728880.000218">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1533728880.000218">2018-08-08 20:48:00 +0900</a></div>
          </div>
          <div class="description">以下のコードをビルドすると <code>Orphan instance: instance From Word8 HogeSerializeFormat</code> という警告が出てしまいます。<br/><a href='https://repl.it/repls/SilverIntentEmulator'>https://repl.it/repls/SilverIntentEmulator</a><br/><code>{-# OPTIONS_GHC -fno-warn-orphans #-}</code> をつければ警告を消せるようなのですが、そもそもこの警告は何が問題なのでしょうか？（実行時にエラーになる場合があるなど）<br/>ネットで調べてみると <code>instance From Word8 HogeSerializeFormat</code> の部分のファイルを分ければよいということが書いてあったのですが、分けようとした（module Data.Word内に書いてみた）際に循環importになってしまいビルドができなくなってしまいました。<br/>hs-bootというものを使えば解決できると書いてあったのですが、僕の理解が間違っているのかhs-boot内でお互いをimportしてしまい、結局循環import問題が発生してしまいました。<br/>長くなりましたが、この問題はどう解決するのがベストなのでしょうか？ <code>{-# OPTIONS_GHC -fno-warn-orphans #-}</code> をつけて警告を消してしまってよいのか、それとも別の方法がよいのか。<br/>よろしくお願い致します。</div>
        </div>
      </div>
      <div class="event" id="message-1533730689.000201">
        <div class="content">
          <div class="summary">
            <div class="user">igrep</div>
            <div class="date"><a class="date" href="#message-1533730689.000201">2018-08-08 21:18:09 +0900</a></div>
          </div>
          <div class="description"><blockquote><code>{-# OPTIONS_GHC -fno-warn-orphans #-}</code> をつければ警告を消せるようなのですが、そもそもこの警告は何が問題なのでしょうか？</blockquote><br/>実行時エラーが起こると言うことはありません。<br/>この警告は、<br/>- 「ある型クラスの定義」と「ある型に対するその型クラスのインスタンスの定義」<br/>- 「ある型の定義」と「その型に対するある型クラスのインスタンスの定義」<br/>がすべて別のモジュールに分かれてしまっている場合に起こります。<br/>今回の場合、<br/><pre>
instance From HogeSerializeFormat Word8
</pre><br/>などのインスタンスの定義が問題になっているわけですが、<br/>これは、 <code>Word8</code> という型の定義と、 <code>From</code> という型クラスの定義、どちらのモジュールとも異なるモジュールで宣言しているから <code>Orphan instance</code> と言われてしまいます。<br/>インスタンスの定義だけが型クラスの定義からも型の定義からも離れた、 "orphan" （孤児）になってしまっているから "Orphan instance" といいます。</div>
        </div>
      </div>
      <div class="event" id="message-1533730937.000111">
        <div class="content">
          <div class="summary">
            <div class="user">igrep</div>
            <div class="date"><a class="date" href="#message-1533730937.000111">2018-08-08 21:22:17 +0900</a></div>
          </div>
          <div class="description">で、何が問題なのかというと、どのモジュールを import したらいいのかわかりづらくなってしまうという問題があります。<br/><code>Word8</code> について <code>From</code> のインスタンスがあることを知っていても、 <code>Word8</code> が定義されたモジュール、 <code>From</code> が定義されたモジュール、どちらを import してもインスタンスが利用できないため、使おうとしたときに迷ってしまう恐れがあるのです。</div>
        </div>
      </div>
      <div class="event" id="message-1533731623.000315">
        <div class="content">
          <div class="summary">
            <div class="user">igrep</div>
            <div class="date"><a class="date" href="#message-1533731623.000315">2018-08-08 21:33:43 +0900</a></div>
          </div>
          <div class="description">実際のところ、orphan instanceは意図的に定義されることもしばしばあります。<br/>そういう場合のために、警告として、無効にできるようになっているのです。<br/>例えばいろいろな型に使える、汎用性の高い型クラスを提供するパッケージAがあるとします。<br/>Aの作者はできるだけいろいろな型をその型クラスのインスタンスにしようとしますが、実際にはあらゆる型をサポートできるわけではありません。<br/>Aがリリースされた後に新しい、Aが提供する型クラスにふさわしい型がリリースされるなんてことは十分あり得ますし、そもそそもあらゆる型をサポートするために、Aの依存パッケージを増やすということは、できるだけ避けるべきです。<br/><br/>それでもAが提供する型クラスのインスタンスを、あの型にも提供したい！という場合に、orphan instance専用のパッケージが作られることがしばしばあります。<br/>「hogehoge-instances」なんて名前のパッケージがあったら、多くの場合そうしたorphan instance専門のパッケージです。<br/>探してみると面白いでしょう。<br/><a href='http://hackage.haskell.org/packages/search?terms=instances'>http://hackage.haskell.org/packages/search?terms=instances</a></div>
        </div>
      </div>
      <div class="event" id="message-1533731722.000262">
        <div class="content">
          <div class="summary">
            <div class="user">igrep</div>
            <div class="date"><a class="date" href="#message-1533731722.000262">2018-08-08 21:35:22 +0900</a></div>
          </div>
          <div class="description">今回の場合は、 <code>instance From HogeSerializeFormat Word8</code> などを <code>Data.From</code> モジュールに移動させれば、<br/>「ある型クラスの定義」と「ある型に対するその型クラスのインスタンスの定義」<br/>が同じモジュールに含まれるようになるため、問題ないはずです。</div>
        </div>
      </div>
      <div class="event" id="message-1533732128.000165">
        <div class="content">
          <div class="summary">
            <div class="user">igrep</div>
            <div class="date"><a class="date" href="#message-1533732128.000165">2018-08-08 21:42:08 +0900</a></div>
          </div>
          <div class="description">後で調べてわかったんですが、Coercibleはユーザーが自分でインスタンスを定義できるものではなく、GHCが自動でCoercibleかどうか判定するという非常に特殊なものなので、RustのFromとはずいぶん性格が違うようです。。。</div>
        </div>
      </div>
      <div class="event" id="message-1533733975.000113">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1533733975.000113">2018-08-08 22:12:55 +0900</a></div>
          </div>
          <div class="description">なるほど！ <code>Data.From</code> に移動すればよかったのですね！<br/>移動したところ警告が出ずにビルドすることができました！<br/>丁寧にご説明していただき、ありがとうございます！</div>
        </div>
      </div>
      <div class="event" id="message-1533740355.000112">
        <div class="content">
          <div class="summary">
            <div class="user">as_capabl</div>
            <div class="date"><a class="date" href="#message-1533740355.000112">2018-08-08 23:59:15 +0900</a></div>
          </div>
          <div class="description">Orphan instanceを避けるべき理由としては他に、ライブラリaとライブラリbがそれぞれ勝手にinstance宣言をして、それらが被っていると、それらを同じプロジェクトで使った時に問答無用で重複エラーになる、すなわちライブラリaとbを同時に使う事が出来なくなる、というのがありますね。なので、ライブラリでなくexeのソースでやる分には結構大丈夫なんじゃないかと思ったりします</div>
        </div>
      </div>
      <div class="event" id="message-1533778791.000080">
        <div class="content">
          <div class="summary">
            <div class="user">myuon_myon</div>
            <div class="date"><a class="date" href="#message-1533778791.000080">2018-08-09 10:39:51 +0900</a></div>
          </div>
          <div class="description">GADTの計算するときに使えるときもあります</div>
        </div>
      </div>
      <div class="event" id="message-1533780206.000023">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1533780206.000023">2018-08-09 11:03:26 +0900</a></div>
          </div>
          <div class="description">ライブラリでやりたいので注意してやっていこうと思います！</div>
        </div>
      </div>
      <div class="event" id="message-1534602712.000200">
        <div class="content">
          <div class="summary">
            <div class="user">Tsuyoshi Miyamoto</div>
            <div class="date"><a class="date" href="#message-1534602712.000200">2018-08-18 23:31:52 +0900</a></div>
          </div>
          <div class="description">@Tsuyoshi Miyamoto has joined the channel</div>
        </div>
      </div>
      <div class="event" id="message-1535182965.000200">
        <div class="content">
          <div class="summary">
            <div class="user">hoge</div>
            <div class="date"><a class="date" href="#message-1535182965.000200">2018-08-25 16:42:45 +0900</a></div>
          </div>
          <div class="description">@hoge has joined the channel</div>
        </div>
      </div>
      <div class="event" id="message-1535240078.000200">
        <div class="content">
          <div class="summary">
            <div class="user">JokerTheWild</div>
            <div class="date"><a class="date" href="#message-1535240078.000200">2018-08-26 08:34:38 +0900</a></div>
          </div>
          <div class="description">@JokerTheWild has joined the channel</div>
        </div>
      </div>
      <div class="event" id="message-1535465561.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535465561.000100">2018-08-28 23:12:41 +0900</a></div>
          </div>
          <div class="description">Conduit(cereal-conduit)について質問させてください。<br/>cereal-conduitで定義されている <code>conduitGet2</code> を真似して（ほぼコピペ）デシリアライズした値と一緒に、今何バイト目にいるのかをタプルで返すコードを書いてみたのですがコンパイルエラーになってしまいうまく行きません。<br/><code>i &lt;- IO.hTell h</code> の部分を <code>i &lt;- return 123</code> などにするとコンパイルはできたのですが、なぜ <code>i &lt;- IO.hTell h</code> だとエラーになってしまうのかがわからない状況です。<br/>上記の質問とは少しずれてしまうのですが、自分で <code>conduitGet3</code> などを定義せず既存の <code>conduitGet2</code> を使いつつ今何バイト目にいるのかをデシリアライズした値と一緒に返す方法なんてあったりするのでしょうか？<br/>ちなみにエラーメッセージはこんな感じです。よろしくお願い致します。<br/><pre>
    • Couldn't match type ‘IO’
                     with ‘ConduitT BS.ByteString (o, Integer) m’
      Expected type: ConduitT BS.ByteString (o, Integer) m Integer
        Actual type: IO Integer
    • In a stmt of a 'do' block: i &lt;- IO.hTell h
      In the expression:
        do i &lt;- IO.hTell h
           yield (x, i)
           if BS.null rest then awaitNE &gt;&gt;= start else start rest
      In an equation for ‘result’:
          result (Done x rest)
            = do i &lt;- IO.hTell h
                 yield (x, i)
                 if BS.null rest then awaitNE &gt;&gt;= start else start rest
    • Relevant bindings include
        x :: o (bound at app/Main.hs:73:18)
        result :: Result o -&gt; ConduitT BS.ByteString (o, Integer) m ()
          (bound at app/Main.hs:66:5)
        awaitNE :: forall o. ConduitT BS.ByteString o m BS.ByteString
          (bound at app/Main.hs:54:5)
        g :: Get o (bound at app/Main.hs:49:15)
        conduitGet3 :: IO.Handle
                       -&gt; Get o -&gt; ConduitT BS.ByteString (o, Integer) m ()
          (bound at app/Main.hs:49:1)
   |
74 |         i &lt;- IO.hTell h
   |              ^^^^^^^^^^
</pre></div>
        </div>
      </div>
      <div class="event" id="message-1535466661.000100">
        <div class="content">
          <div class="summary">
            <div class="user"></div>
            <div class="date"><a class="date" href="#message-1535466661.000100">2018-08-28 23:31:01 +0900</a></div>
          </div>
          <div class="description">まず単純なエラーメッセージの解釈ですが， <code>IO.hTell h</code> は <code>IO Integer</code> 型になりますが <code>result :: Data.Serialize.Result o -&gt; ConduitT BS.ByteString (o, Integer) m ()</code> 型になるため， <code>do</code> 構文の制約により <code>ConduitT BS.ByteString (o, Integer) m</code> モナドでなく <code>IO</code> モナドを使っているためエラーになります． <code>return 123</code> にするとうまくいくのは， <code>return 123 :: ConduitT BS.ByteString (o, Integer) m Integer</code> となるためです．<br/>なお，型がどう推論されているかは，Type holeという機能を使って <code>result :: _ -&gt; _</code> とすればエラーメッセージとして表示されるようになります．</div>
        </div>
      </div>
      <div class="event" id="message-1535466915.000100">
        <div class="content">
          <div class="summary">
            <div class="user"></div>
            <div class="date"><a class="date" href="#message-1535466915.000100">2018-08-28 23:35:15 +0900</a></div>
          </div>
          <div class="description">それで修正案に入る前に，要件の確認なのですが，この関数は，<br/><code>runConduit $ sourceHandle h .| conduitGet3 h .| sinkList</code><br/>というような感じで <code>sourceHandle</code> に渡されたハンドルを <code>conduitGet3</code> にも渡される前提で使用するという想定で合ってますか？</div>
        </div>
      </div>
      <div class="event" id="message-1535467057.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535467057.000100">2018-08-28 23:37:37 +0900</a></div>
          </div>
          <div class="description">夜分遅くにありがとうございます！<br/>はい！そんな感じです！ <code>runConduit $ CC.sourceHandle h .| conduitGet3 h (get :: Get Value.Value) .| CC.mapM_ print</code> で画面に表示されるか試していました！</div>
        </div>
      </div>
      <div class="event" id="message-1535467161.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535467161.000100">2018-08-28 23:39:21 +0900</a></div>
          </div>
          <div class="description">Type hole…知りませんでした…！</div>
        </div>
      </div>
      <div class="event" id="message-1535467479.000100">
        <div class="content">
          <div class="summary">
            <div class="user"></div>
            <div class="date"><a class="date" href="#message-1535467479.000100">2018-08-28 23:44:39 +0900</a></div>
          </div>
          <div class="description">これは，HandleのPositionでなくてはだめでしょうか？例えば，Data.SerializeのbytesReadを使うと，<br/><pre>
conduitGet3 :: MonadThrow m =&gt; Get o -&gt; ConduitT BS.ByteString (o, Int) m ()
conduitGet3 g = conduitGet2 (twoOf g bytesRead)
</pre><br/>みたいなことができます．</div>
        </div>
      </div>
      <div class="event" id="message-1535467905.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535467905.000100">2018-08-28 23:51:45 +0900</a></div>
          </div>
          <div class="description">HandleのPositionにこだわりはありません！今何バイト目にいるのかがわかれば問題ありません！デシリアライズ対象のデータの先頭が何バイト目なのかが知りたいだけですので！<br/><code>twoOf</code> という関数をググっても出てこないのですがこれはどこで定義されている関数でしょうか？</div>
        </div>
      </div>
      <div class="event" id="message-1535467915.000100">
        <div class="content">
          <div class="summary">
            <div class="user"></div>
            <div class="date"><a class="date" href="#message-1535467915.000100">2018-08-28 23:51:55 +0900</a></div>
          </div>
          <div class="description">いちよ，現状の <code>conduitGet3</code> を修正する場合， <a href='http://hackage.haskell.org/package/base-4.11.1.0/docs/Control-Monad-IO-Class.html'>http://hackage.haskell.org/package/base-4.11.1.0/docs/Control-Monad-IO-Class.html</a> を使用して <code>hTell h</code> の部分を <code>liftIO (hTell h)</code> にすれば動くはずです．</div>
        </div>
      </div>
      <div class="event" id="message-1535467954.000100">
        <div class="content">
          <div class="summary">
            <div class="user"></div>
            <div class="date"><a class="date" href="#message-1535467954.000100">2018-08-28 23:52:34 +0900</a></div>
          </div>
          <div class="description">あ，すいません，s/twoOf/getTwoOf/ です． <a href='http://hackage.haskell.org/package/cereal-0.5.7.0/docs/Data-Serialize-Get.html#v:getTwoOf'>http://hackage.haskell.org/package/cereal-0.5.7.0/docs/Data-Serialize-Get.html#v:getTwoOf</a> これですね</div>
        </div>
      </div>
      <div class="event" id="message-1535468157.000100">
        <div class="content">
          <div class="summary">
            <div class="user"></div>
            <div class="date"><a class="date" href="#message-1535468157.000100">2018-08-28 23:55:57 +0900</a></div>
          </div>
          <div class="description">あ，できないかもしれないです．これだと，ずっとPositionが0になるのか…</div>
        </div>
      </div>
      <div class="event" id="message-1535468573.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535468573.000100">2018-08-29 00:02:53 +0900</a></div>
          </div>
          <div class="description">実行してみましたが確かに毎回Positionがリセットされてしまいますね</div>
        </div>
      </div>
      <div class="event" id="message-1535468822.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535468822.000100">2018-08-29 00:07:02 +0900</a></div>
          </div>
          <div class="description">liftIOを試してみましたがビルドエラーになってしまいました<br/><pre>
    • Could not deduce (MonadIO m) arising from a use of ‘liftIO’
      from the context: MonadThrow m
        bound by the type signature for:
                   conduitGet3 :: forall (m :: * -&gt; *) o.
                                  MonadThrow m =&gt;
                                  IO.Handle -&gt; Get o -&gt; ConduitT BS.ByteString (o, Integer) m ()
        at app/Main.hs:49:1-93
      Possible fix:
        add (MonadIO m) to the context of
          the type signature for:
            conduitGet3 :: forall (m :: * -&gt; *) o.
                           MonadThrow m =&gt;
                           IO.Handle -&gt; Get o -&gt; ConduitT BS.ByteString (o, Integer) m ()
    • In a stmt of a 'do' block: i &lt;- liftIO (IO.hTell h)
      In the expression:
        do i &lt;- liftIO (IO.hTell h)
           yield (x, i)
           if BS.null rest then awaitNE &gt;&gt;= start else start rest
      In an equation for ‘result’:
          result (Done x rest)
            = do i &lt;- liftIO (IO.hTell h)
                 yield (x, i)
                 if BS.null rest then awaitNE &gt;&gt;= start else start rest
   |
75 |         i &lt;- liftIO (IO.hTell h)
   |              ^^^^^^^^^^^^^^^^^^^
</pre></div>
        </div>
      </div>
      <div class="event" id="message-1535469098.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535469098.000100">2018-08-29 00:11:38 +0900</a></div>
          </div>
          <div class="description">あ、 <code>conduitGet3 :: (MonadThrow m, MonadIO m) =&gt; IO.Handle -&gt; Get o -&gt; ConduitT BS.ByteString (o, Integer) m ()</code> にしたらビルドできました！</div>
        </div>
      </div>
      <div class="event" id="message-1535469224.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535469224.000100">2018-08-29 00:13:44 +0900</a></div>
          </div>
          <div class="description">ビルドはできたのですが出力結果が<br/><pre>
(Nil,3)
(Bool True,3)
(Bool False,3)
</pre><br/>となってしまいました :sob:<br/><br/>本当は<br/><pre>
(Nil,0)
(Bool True,1)
(Bool False,2)
</pre><br/>となってほしいのですが…</div>
        </div>
      </div>
      <div class="event" id="message-1535469318.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535469318.000100">2018-08-29 00:15:18 +0900</a></div>
          </div>
          <div class="description">遅延評価だから全部最後の状態のを見てしまっているということなのでしょうか…？</div>
        </div>
      </div>
      <div class="event" id="message-1535469462.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535469462.000100">2018-08-29 00:17:42 +0900</a></div>
          </div>
          <div class="description">ちなみに <code>echo -en "\x00\x01\x02"</code> で作成したファイルを読ませていて、0x00がNil、0x01がBool True、0x02がBool Falseとなっております</div>
        </div>
      </div>
      <div class="event" id="message-1535469988.000100">
        <div class="content">
          <div class="summary">
            <div class="user"></div>
            <div class="date"><a class="date" href="#message-1535469988.000100">2018-08-29 00:26:28 +0900</a></div>
          </div>
          <div class="description">いえ実はその問題は指摘しようと思ってたのですが， sourceFile は256kBごとによみとるため， hTellで取り出せるのは読み込んだ後(パースされた文字列のポジションではなく)の値になります．今回の例では最初に最後までHandleが読み込まれてしまった結果そうなったのだと思います</div>
        </div>
      </div>
      <div class="event" id="message-1535470434.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535470434.000100">2018-08-29 00:33:54 +0900</a></div>
          </div>
          <div class="description">そ、そんな…この機能を実現するのはConduitではできないのでしょうか…？<br/>そもそも僕のこのやり方がおかしいのでしょうか…？</div>
        </div>
      </div>
      <div class="event" id="message-1535470477.000100">
        <div class="content">
          <div class="summary">
            <div class="user"></div>
            <div class="date"><a class="date" href="#message-1535470477.000100">2018-08-29 00:34:37 +0900</a></div>
          </div>
          <div class="description">HandleのPositionを使わない場合，こんな感じで書けます．<br/><a href='https://gist.github.com/mizunashi-mana/9e8f9703cf21698a4312ba19874bcd48'>https://gist.github.com/mizunashi-mana/9e8f9703cf21698a4312ba19874bcd48</a><br/><br/>HandleのPositionを使う場合上の問題があるため，結局Position修正を行わなければならないためhTellを使うよりこっちのほうがいいかもしれません．</div>
        </div>
      </div>
      <div class="event" id="message-1535470796.000100">
        <div class="content">
          <div class="summary">
            <div class="user"></div>
            <div class="date"><a class="date" href="#message-1535470796.000100">2018-08-29 00:39:56 +0900</a></div>
          </div>
          <div class="description">うーん，おそらくですが <code>conduitGet2</code> を流用するのは無理なんじゃないかなと思いますね．やるとしたらConduitに新しいAPIを足さなきゃいけない気がします(<http://hackage.haskell.org/package/conduit-1.3.0.3/docs/src/Data.Conduit.Internal.Pipe.html#Pipe> らへん低下層のデータ型を操作するようなAPIを足せば色々できると思いますね．今回の場合に使えるAPIはあってもおかしくないと思うんですが，探した感じ見つかりませんでした)</div>
        </div>
      </div>
      <div class="event" id="message-1535470873.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535470873.000100">2018-08-29 00:41:13 +0900</a></div>
          </div>
          <div class="description">なるほど、内部でカウンタをもつということですね！</div>
        </div>
      </div>
      <div class="event" id="message-1535470895.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535470895.000100">2018-08-29 00:41:35 +0900</a></div>
          </div>
          <div class="description">なるほど、流用は難しいですか…</div>
        </div>
      </div>
      <div class="event" id="message-1535471458.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535471458.000100">2018-08-29 00:50:58 +0900</a></div>
          </div>
          <div class="description">あー…！完全に後出しジャンケンなのですが、 <code>echo -en "\x00\x01\x02\x08\x01"</code> こんな感じで <code>\x08\x01</code> の2つで <code>UInt8 1</code> のようなデータもあるんです…<br/>これ、先程の内部でカウンタ持つやり方だとできないですかね…？</div>
        </div>
      </div>
      <div class="event" id="message-1535471497.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535471497.000100">2018-08-29 00:51:37 +0900</a></div>
          </div>
          <div class="description">あ、bytesReadで何バイト読んだかわかるからそれをカウンタに足せばいけますかね！？</div>
        </div>
      </div>
      <div class="event" id="message-1535471695.000100">
        <div class="content">
          <div class="summary">
            <div class="user"></div>
            <div class="date"><a class="date" href="#message-1535471695.000100">2018-08-29 00:54:55 +0900</a></div>
          </div>
          <div class="description">それさっき思いついて実装してます．ちょっと応用すれば簡単に流用できましたね…なるほど</div>
        </div>
      </div>
      <div class="event" id="message-1535471909.000100">
        <div class="content">
          <div class="summary">
            <div class="user"></div>
            <div class="date"><a class="date" href="#message-1535471909.000100">2018-08-29 00:58:29 +0900</a></div>
          </div>
          <div class="description"><pre>

conduitGet4 :: MonadThrow m =&gt; Get o -&gt; ConduitT BS.ByteString (o, Int) m ()
conduitGet4 g = conduitGet2 ((,) &lt;$&gt; g &lt;*&gt; bytesRead) .| conduitPosFix 0
  where
    conduitPosFix !p = await &gt;&gt;= \case
      Nothing -&gt; pure ()
      Just (x, l) -&gt; do
        yield (x, p)
        conduitPosFix $ p + l
</pre><br/>こんな単純にできそうですね…</div>
        </div>
      </div>
      <div class="event" id="message-1535472062.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535472062.000100">2018-08-29 01:01:02 +0900</a></div>
          </div>
          <div class="description">おお！</div>
        </div>
      </div>
      <div class="event" id="message-1535472172.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535472172.000100">2018-08-29 01:02:52 +0900</a></div>
          </div>
          <div class="description">あら、ビルドエラーになってしまいました…<br/><pre>
error: parse error on input ‘case’
   |
84 |     conduitPosFix !p = await &gt;&gt;= \case
   |
</pre></div>
        </div>
      </div>
      <div class="event" id="message-1535472533.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535472533.000100">2018-08-29 01:08:53 +0900</a></div>
          </div>
          <div class="description">いろいろ試してみましたがまだHaskellの文法をきちんと理解できておらず↑のビルドエラーを直せませんでした…</div>
        </div>
      </div>
      <div class="event" id="message-1535472817.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535472817.000100">2018-08-29 01:13:37 +0900</a></div>
          </div>
          <div class="description">あ！ <code>-XLambdaCase</code> が必要なんですね！失礼しました！</div>
        </div>
      </div>
      <div class="event" id="message-1535472837.000100">
        <div class="content">
          <div class="summary">
            <div class="user"></div>
            <div class="date"><a class="date" href="#message-1535472837.000100">2018-08-29 01:13:57 +0900</a></div>
          </div>
          <div class="description">あすいません、  {-# LANGUAGE LambdaCase #-} が必要です</div>
        </div>
      </div>
      <div class="event" id="message-1535473240.000100">
        <div class="content">
          <div class="summary">
            <div class="user">otake84</div>
            <div class="date"><a class="date" href="#message-1535473240.000100">2018-08-29 01:20:40 +0900</a></div>
          </div>
          <div class="description"><pre>
    Variable not in scope:
      conduitPosFix :: Integer -&gt; ConduitM (o, Int) (o, Int) m ()
   |
82 | conduitGet4 g = conduitGet2 ((,) &lt;$&gt; g &lt;*&gt; bytesRead) .| conduitPosFix 0
   |                                                          ^^^^^^^^^^^^^
</pre><br/>whereでconduitPosFixが定義されているのにエラーになってしまう…</div>
        </div>
      </div>
    </div>
    <div class="ui pagination menu">
      <a href="../../html/C5666B6BB/25.html" class="item">Previous</a>
      <a href="../../" class="item">Top</a>
      <a href="../../html/C5666B6BB/27.html" class="item">Next</a>
    </div>
  </div>
</body>
</html>
