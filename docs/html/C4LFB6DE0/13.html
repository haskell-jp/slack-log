<!DOCTYPE html><html><head><meta charset="utf-8"><title>haskell-jp / general #13</title><link rel="stylesheet" href="/messages.css" type="text/css" media="screen"></head><body><h1>haskell-jp / general #13</h1><div class="pager"><a href="/html/C4LFB6DE0/12.html" class="pager__previous">Previous</a><a href="/" class="pager__top">Top</a><a href="/html/C4LFB6DE0/14.html" class="pager__next">Next</a></div><div class="message_list"><div class="message" id="message-1543753986.001400"><div class="message__timestamp">2018-12-02<br/>21:33:06 +0900</div><div class="message__header">noolbar</div><div class="message__body">@noolbar has joined the channel</div></div><div class="message" id="message-1543798827.001600"><div class="message__timestamp">2018-12-03<br/>10:00:27 +0900</div><div class="message__header">slackbot</div><div class="message__body">Reminder: <a href='https://haskell-jp.slack.com/archives/C4LFB6DE0/p1517792426000233'>https://haskell-jp.slack.com/archives/C4LFB6DE0/p1517792426000233</a></div></div><div class="message" id="message-1543843574.002400"><div class="message__timestamp">2018-12-03<br/>22:26:14 +0900</div><div class="message__header">kagilinn</div><div class="message__body">@kagilinn has joined the channel</div></div><div class="message" id="message-1543884354.008100"><div class="message__timestamp">2018-12-04<br/>09:45:54 +0900</div><div class="message__header">kagilinn</div><div class="message__body">Qiita の Advent Calendar の某記事でここに興味を持ち Slack を始めました, 見るだけになってしまうかも知れませんが, もしもの時はよろしくお願い申し上げます.</div></div><div class="message" id="message-1543896317.008900"><div class="message__timestamp">2018-12-04<br/>13:05:17 +0900</div><div class="message__header">igarashi.kouki</div><div class="message__body">@igarashi.kouki has joined the channel</div></div><div class="message" id="message-1543914817.010200"><div class="message__timestamp">2018-12-04<br/>18:13:37 +0900</div><div class="message__header">irxnjhtchlnrw</div><div class="message__body">@irxnjhtchlnrw has joined the channel</div></div><div class="message" id="message-1544031201.010900"><div class="message__timestamp">2018-12-06<br/>02:33:21 +0900</div><div class="message__header">pontyan12</div><div class="message__body">@pontyan12 has joined the channel</div></div><div class="message" id="message-1544065969.011200"><div class="message__timestamp">2018-12-06<br/>12:12:49 +0900</div><div class="message__header">idkphys.030zzz</div><div class="message__body">@idkphys.030zzz has joined the channel</div></div><div class="message" id="message-1544141319.011500"><div class="message__timestamp">2018-12-07<br/>09:08:39 +0900</div><div class="message__header">chakaji2002</div><div class="message__body">@chakaji2002 has joined the channel</div></div><div class="message" id="message-1544141462.012300"><div class="message__timestamp">2018-12-07<br/>09:11:02 +0900</div><div class="message__header">chakaji2002</div><div class="message__body">はじめまして。Haskell初心者で分からないことだらけですが、頑張りますのでどうぞよろしくお願いいたします。</div></div><div class="message" id="message-1544141823.015900"><div class="message__timestamp">2018-12-07<br/>09:17:03 +0900</div><div class="message__header">chakaji2002</div><div class="message__body">質問させて頂きます。Haskellのwebアプリ（wai）の勉強をしているのですが、以下のソースコードの24行目、"こんにちわ"の部分が、ブラウザ上で見ると文字化けしてしまいます。文字コード変換の問題かと思うのですが、どうしても解消できませんでした。どうぞお知恵をお貸しください。<br/><br/>{-# LANGUAGE OverloadedStrings #-}<br/><br/>module Lib<br/>    ( someFunc<br/>    ) where<br/><br/><br/>import Network.Wai (Application, responseLBS)<br/>import Network.HTTP.Types (status200)<br/>import Network.Wai.Handler.Warp (run,Port)<br/>import System.Environment(getEnvironment)<br/>import Data.List(lookup)<br/>import Data.Maybe<br/><br/><br/>someFunc :: IO ()<br/>someFunc = do<br/>  port &lt;- getPort<br/>  Prelude.putStr "start Server: http://localhost:"<br/>  print port<br/>  run port helloApp<br/><br/>helloApp :: Application<br/>helloApp req respond =respond<br/>                      $ responseLBS status200 [] "こんにちわ"　# ←　この部分です<br/><br/>getPort :: IO Port<br/>getPort = getEnvironment <blockquote><blockquote>= return . port</blockquote>  where</blockquote>    port = fromMaybe defaultPort . fmap read . lookup "PORT"<br/><br/>defaultPort :: Port<br/>defaultPort = 3000</div></div><div class="message" id="message-1544143899.016300"><div class="message__timestamp">2018-12-07<br/>09:51:39 +0900</div><div class="message__header">igrep</div><div class="message__body">ああー、ByteStringの文字列リテラルの罠ですね。。。<br/>取り急ぎ結論から言うと、<br/><code>"こんにちわ"</code> に <code>Data.Text.Lazy.Encoding.encodeUtf8</code> <a href='http://hackage.haskell.org/package/text-1.2.3.1/docs/Data-Text-Lazy-Encoding.html#v:encodeUtf8'>http://hackage.haskell.org/package/text-1.2.3.1/docs/Data-Text-Lazy-Encoding.html#v:encodeUtf8</a> を適用すれば解決するはずです。</div></div><div class="message" id="message-1544144797.016500"><div class="message__timestamp">2018-12-07<br/>10:06:37 +0900</div><div class="message__header">fumieval</div><div class="message__body">IsString ByteStringは罠ですね…</div></div><div class="message" id="message-1544145294.016700"><div class="message__timestamp">2018-12-07<br/>10:14:54 +0900</div><div class="message__header">chakaji2002</div><div class="message__body">igrep 様、fumieval様、真に有難うございました。ソースコードを以下のように訂正しました所、文字化けが解消しました。大変お世話になり、真に有難うございました。<br/>　Chromeですと、さらにブラウザ自身の文字コードもUTF-8にしないといけないのですね。。大変勉強になりました。（FireFoxはそのままできれいに表示されました。）<br/><br/>import Data.Text.Lazy.Encoding # 追加<br/><br/>hello= encodeUtf8 "こんにちわ" # 追加・変更</div></div><div class="message" id="message-1544145386.017000"><div class="message__timestamp">2018-12-07<br/>10:16:26 +0900</div><div class="message__header">chakaji2002</div><div class="message__body">grep 様、fumieval様、真に有難うございました。ソースコードを以下のように訂正しました所、文字化けが解消しました。大変お世話になり、真に有難うございました。<br/>　Chromeですと、さらにブラウザ自身の文字コードもUTF-8にしないといけないのですね。。大変勉強になりました。（FireFoxはそのままできれいに表示されました。）<br/><br/>import Data.Text.Lazy.Encoding # 追加<br/><br/>hello= encodeUtf8 "こんにちわ" # 追加・変更</div></div><div class="message" id="message-1544145477.017600"><div class="message__timestamp">2018-12-07<br/>10:17:57 +0900</div><div class="message__header">chakaji2002</div><div class="message__body">igrep　様、名前のiが抜けてしまっておりました。大変失礼いたしました。申し訳ありませんでした。</div></div><div class="message" id="message-1544145501.017900"><div class="message__timestamp">2018-12-07<br/>10:18:21 +0900</div><div class="message__header">igrep</div><div class="message__body">詳しく言うと、これはOverloadedStringsを使ってBytStringの文字列リテラルを書いたことによる問題です。<br/>OverloadedStringsを使ってBytStringの文字列リテラルを書いた場合、内部でBytStringのfromStringというStringからBytStringに変換する関数（<@U4KUNQF9N>さんが触れてるIsStringのメソッドです）を呼んでいるのですが、各Charの1バイト目の値しかとらないため、 "こんにちわ" の各文字が切れてしまうのです</div></div><div class="message" id="message-1544145513.018100"><div class="message__timestamp">2018-12-07<br/>10:18:33 +0900</div><div class="message__header">hiratara</div><div class="message__body"><blockquote>Chromeですと、さらにブラウザ自身の文字コードもUTF-8に</blockquote>そんなことなかった気もしますが、その辺は WAI 関係なく web の話なので、 response header に <code>Content-Type:
text/html; charset=UTF-8</code> 加えるなどするのがいいと思います。</div></div><div class="message" id="message-1544145571.018600"><div class="message__timestamp">2018-12-07<br/>10:19:31 +0900</div><div class="message__header">igrep</div><div class="message__body">@chakaji2002 すみません、原則として「Also send to <a href='#C4LFB6DE0'>general</a> 」は使わないでください。</div></div><div class="message" id="message-1544145628.018900"><div class="message__timestamp">2018-12-07<br/>10:20:28 +0900</div><div class="message__header">chakaji2002</div><div class="message__body">@igrep 有難うございます。よくわからないまま、チェックを入れてしまっておりました。申し訳ありません。</div></div><div class="message" id="message-1544145730.019100"><div class="message__timestamp">2018-12-07<br/>10:22:10 +0900</div><div class="message__header">chakaji2002</div><div class="message__body">hiratara　様　有難うございます。また、いろいろ試して、勉強してみたいと思います。</div></div><div class="message" id="message-1544247441.020000"><div class="message__timestamp">2018-12-08<br/>14:37:21 +0900</div><div class="message__header">irissetosa976</div><div class="message__body">@irissetosa976 has joined the channel</div></div><div class="message" id="message-1544356253.020400"><div class="message__timestamp">2018-12-09<br/>20:50:53 +0900</div><div class="message__header">wakaka2277</div><div class="message__body">@wakaka2277 has joined the channel</div></div><div class="message" id="message-1544361151.020700"><div class="message__timestamp">2018-12-09<br/>22:12:31 +0900</div><div class="message__header">t-era</div><div class="message__body">@t-era has joined the channel</div></div><div class="message" id="message-1544401078.021000"><div class="message__timestamp">2018-12-10<br/>09:17:58 +0900</div><div class="message__header">lyrical.magical.techn</div><div class="message__body">@lyrical.magical.techn has joined the channel</div></div><div class="message" id="message-1544403601.021200"><div class="message__timestamp">2018-12-10<br/>10:00:01 +0900</div><div class="message__header">slackbot</div><div class="message__body">Reminder: <a href='https://haskell-jp.slack.com/archives/C4LFB6DE0/p1517792426000233'>https://haskell-jp.slack.com/archives/C4LFB6DE0/p1517792426000233</a></div></div><div class="message" id="message-1544747872.021900"><div class="message__timestamp">2018-12-14<br/>09:37:52 +0900</div><div class="message__header">goto.ryota</div><div class="message__body">@goto.ryota has joined the channel</div></div><div class="message" id="message-1544768067.027600"><div class="message__timestamp">2018-12-14<br/>15:14:27 +0900</div><div class="message__header">akagi15</div><div class="message__body">抽象的な質問で恐縮ですが、質問させていただきます。<br/>先程hClose を忘れていたせいでoutput の末尾だけ欠損して毎回その数が異なるというバグと戦っておりました。<br/>何かを呼び出した後に、特定の関数を呼び出していない場合にエラーを表示するような機能を付ける場合、template Haskell 等でコンパイル時に判断する他に手段があるでしょうか。</div></div><div class="message" id="message-1544768453.027700"><div class="message__timestamp">2018-12-14<br/>15:20:53 +0900</div><div class="message__header">igrep</div><div class="message__body">いかなる条件でも絶対に呼び出すことを保証するのは、そもそもTemplate Haskellでも難しいです。<br/>そうしたAPIや型（ファイルの場合 <code>Handle</code> ）を実装した人が、 <code>bracket</code> を使って作ったAPI （ファイルの場合 <code>withFile</code> ）のみを利用してその型を利用できるようにする、という手はあります。<br/>あと、APIのユーザーとして、 極力 <code>withFile</code> などのAPIだけを利用する、というだけでもそれなりに防げるかと思います。</div></div><div class="message" id="message-1544769012.028100"><div class="message__timestamp">2018-12-14<br/>15:30:12 +0900</div><div class="message__header">akagi15</div><div class="message__body">ありがとうございます.利用者側としては取り敢えずbracketを基本的に使うことを心がけるというのが一番なのですね</div></div><div class="message" id="message-1544775666.028500"><div class="message__timestamp">2018-12-14<br/>17:21:06 +0900</div><div class="message__header">overkill.red99999</div><div class="message__body">@overkill.red99999 has joined the channel</div></div><div class="message" id="message-1544781997.030300"><div class="message__timestamp">2018-12-14<br/>19:06:37 +0900</div><div class="message__header">yharuhi39</div><div class="message__body">bracket や、withXXXX を使うのは前提として ResourceT を使うっていう手もあるにはありますよ。</div></div><div class="message" id="message-1544798202.031400"><div class="message__timestamp">2018-12-14<br/>23:36:42 +0900</div><div class="message__header">as_capabl</div><div class="message__body">Conduitなら必ずhCloseされるよ定期</div></div><div class="message" id="message-1544798232.032000"><div class="message__timestamp">2018-12-14<br/>23:37:12 +0900</div><div class="message__header">as_capabl</div><div class="message__body">実装はResourceTです</div></div><div class="message" id="message-1544888022.032500"><div class="message__timestamp">2018-12-16<br/>00:33:42 +0900</div><div class="message__header">ide_0109</div><div class="message__body">@ide_0109 has joined the channel</div></div><div class="message" id="message-1544947825.032700"><div class="message__timestamp">2018-12-16<br/>17:10:25 +0900</div><div class="message__header">negi23</div><div class="message__body">@negi23 has joined the channel</div></div><div class="message" id="message-1545008430.032800"><div class="message__timestamp">2018-12-17<br/>10:00:30 +0900</div><div class="message__header">slackbot</div><div class="message__body">Reminder: <a href='https://haskell-jp.slack.com/archives/C4LFB6DE0/p1517792426000233'>https://haskell-jp.slack.com/archives/C4LFB6DE0/p1517792426000233</a></div></div><div class="message" id="message-1545040141.033100"><div class="message__timestamp">2018-12-17<br/>18:49:01 +0900</div><div class="message__header">kohsho2015</div><div class="message__body">@kohsho2015 has joined the channel</div></div><div class="message" id="message-1545133272.033500"><div class="message__timestamp">2018-12-18<br/>20:41:12 +0900</div><div class="message__header">e1q18048</div><div class="message__body">@e1q18048 has joined the channel</div></div><div class="message" id="message-1545356661.034400"><div class="message__timestamp">2018-12-21<br/>10:44:21 +0900</div><div class="message__header">snak</div><div class="message__body">@snak has joined the channel</div></div><div class="message" id="message-1545613207.000200"><div class="message__timestamp">2018-12-24<br/>10:00:07 +0900</div><div class="message__header">slackbot</div><div class="message__body">Reminder: <a href='https://haskell-jp.slack.com/archives/C4LFB6DE0/p1517792426000233'>https://haskell-jp.slack.com/archives/C4LFB6DE0/p1517792426000233</a></div></div><div class="message" id="message-1545703254.000600"><div class="message__timestamp">2018-12-25<br/>11:00:54 +0900</div><div class="message__header">aayhrot</div><div class="message__body">@aayhrot has joined the channel</div></div><div class="message" id="message-1545900548.001200"><div class="message__timestamp">2018-12-27<br/>17:49:08 +0900</div><div class="message__header">mo.murakami</div><div class="message__body">@mo.murakami has joined the channel</div></div><div class="message" id="message-1546218023.001400"><div class="message__timestamp">2018-12-31<br/>10:00:23 +0900</div><div class="message__header">slackbot</div><div class="message__body">Reminder: <a href='https://haskell-jp.slack.com/archives/C4LFB6DE0/p1517792426000233'>https://haskell-jp.slack.com/archives/C4LFB6DE0/p1517792426000233</a></div></div><div class="message" id="message-1546305918.001900"><div class="message__timestamp">2019-01-01<br/>10:25:18 +0900</div><div class="message__header">sachiko.nitta</div><div class="message__body">@sachiko.nitta has joined the channel</div></div><div class="message" id="message-1546533160.002400"><div class="message__timestamp">2019-01-04<br/>01:32:40 +0900</div><div class="message__header">mic.ms.co</div><div class="message__body">@mic.ms.co has joined the channel</div></div><div class="message" id="message-1546568348.002700"><div class="message__timestamp">2019-01-04<br/>11:19:08 +0900</div><div class="message__header">kitada.kosuke</div><div class="message__body">@kitada.kosuke has joined the channel</div></div><div class="message" id="message-1546707765.003000"><div class="message__timestamp">2019-01-06<br/>02:02:45 +0900</div><div class="message__header">yethan.goes.asna</div><div class="message__body">@yethan.goes.asna has joined the channel</div></div><div class="message" id="message-1546822817.003200"><div class="message__timestamp">2019-01-07<br/>10:00:17 +0900</div><div class="message__header">slackbot</div><div class="message__body">Reminder: <a href='https://haskell-jp.slack.com/archives/C4LFB6DE0/p1517792426000233'>https://haskell-jp.slack.com/archives/C4LFB6DE0/p1517792426000233</a></div></div><div class="message" id="message-1546877590.003500"><div class="message__timestamp">2019-01-08<br/>01:13:10 +0900</div><div class="message__header">oyasumi60</div><div class="message__body">@oyasumi60 has joined the channel</div></div></div><div class="pager"><a href="/html/C4LFB6DE0/12.html" class="pager__previous">Previous</a><a href="/" class="pager__top">Top</a><a href="/html/C4LFB6DE0/14.html" class="pager__next">Next</a></div></body></html>