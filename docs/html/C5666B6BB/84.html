<!DOCTYPE html><html><head><meta charset="utf-8"><title>haskell-jp / questions #84</title><link rel="stylesheet" href="../../main.css" type="text/css" media="screen"></head><body><div class="ui container"><h1>haskell-jp / questions #84</h1><div class="pager ui pagination menu"><a href="../../html/C5666B6BB/83.html" class="pager__previous item">Previous</a><a href="../../" class="pager__top item">Top</a></div><div class="message_list ui feed"><div class="message event" id="message-1588315812.091400"><div class="content"><div class="summary"><div class="message__header user">igrep</div><div class="message__timestamp date"><a class="date" href="#message-1588315812.091400">2020-05-01&nbsp;15:50:12 +0900</a></div></div><div class="message__body description">詳しい事情はhaskell-cafeあたりで何度か触れられていると思います（自分もぶっちゃけよく調べてない...<br/><a href='https://takenobu-hs.github.io/haskell-wiki-search/?siteview=full'>https://takenobu-hs.github.io/haskell-wiki-search/?siteview=full</a> からチェックを入れて検索してみてください。</div></div></div><div class="message event" id="message-1588315838.091600"><div class="content"><div class="summary"><div class="message__header user">cj.bc-sd</div><div class="message__timestamp date"><a class="date" href="#message-1588315838.091600">2020-05-01&nbsp;15:50:38 +0900</a></div></div><div class="message__body description">みてみます！<br/>ありがとうございます</div></div></div><div class="message event" id="message-1588315860.091800"><div class="content"><div class="summary"><div class="message__header user">igrep</div><div class="message__timestamp date"><a class="date" href="#message-1588315860.091800">2020-05-01&nbsp;15:51:00 +0900</a></div></div><div class="message__body description">あと、base-4.13以降のドキュメントについては <a href='https://wiki.haskell.jp/Hikers%20Guide%20to%20Haskell#base-4.13%E4%BB%A5%E9%99%8D%E3%81%AE%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88'>https://wiki.haskell.jp/Hikers%20Guide%20to%20Haskell#base-4.13%E4%BB%A5%E9%99%8D%E3%81%AE%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88</a> でも触れているとおり、GHC添付のドキュメントを探れ、とのこと。</div></div></div><div class="message event" id="message-1588315927.092000"><div class="content"><div class="summary"><div class="message__header user">cj.bc-sd</div><div class="message__timestamp date"><a class="date" href="#message-1588315927.092000">2020-05-01&nbsp;15:52:07 +0900</a></div></div><div class="message__body description">ｵｫ…知らなかった…<br/>ありがとうございます<br/>ちょっとわかりづらい…</div></div></div><div class="message event" id="message-1588396588.092400"><div class="content"><div class="summary"><div class="message__header user">railo.kanamura</div><div class="message__timestamp date"><a class="date" href="#message-1588396588.092400">2020-05-02&nbsp;14:16:28 +0900</a></div></div><div class="message__body description">@railo.kanamura has joined the channel</div></div></div><div class="message event" id="message-1588400929.092700"><div class="content"><div class="summary"><div class="message__header user">matsumau5</div><div class="message__timestamp date"><a class="date" href="#message-1588400929.092700">2020-05-02&nbsp;15:28:49 +0900</a></div></div><div class="message__body description">@matsumau5 has joined the channel</div></div></div><div class="message event" id="message-1588404058.093000"><div class="content"><div class="summary"><div class="message__header user">akagi15</div><div class="message__timestamp date"><a class="date" href="#message-1588404058.093000">2020-05-02&nbsp;16:20:58 +0900</a></div></div><div class="message__body description">@akagi15 has joined the channel</div></div></div><div class="message event" id="message-1588404290.093200"><div class="content"><div class="summary"><div class="message__header user">akagi15</div><div class="message__timestamp date"><a class="date" href="#message-1588404290.093200">2020-05-02&nbsp;16:24:50 +0900</a></div></div><div class="message__body description">質問させていただきます.<br/>このプログラムのlikeReturn に相当するような処理は実現可能でしょうか?<br/><br/>ST s (STArray s a b) を引数にとって, &lt;ST action&gt; をその内部に適用しつつ,runSTをその内部で利用したいというかなりわがままな利用ができたら色々とキレイに書けるので試行錯誤しています.<br/><br/>&gt;  update i test = readArray  test i &gt;&gt;= writeArray (_test test) (i + 1) <br/>の形にしたり,<br/>&gt; runSTTest :: STTest s -&gt; Int -&gt; ST s Int<br/>にするとシンタックスが手続き型っぽくなるので,できないものかと.<br/><br/>unsafePerformIOを使ってunsafeRunSTを作ればできそうですが悩みどころです.<br/><br/>現行で発生するエラーは下記になります<br/><br/>&gt;  *• Couldn’t match type ‘s1’ with ‘s’*<br/>&gt;    *‘s1’ is a rigid type variable bound by*<br/>&gt;     *the type signature for:*<br/>&gt;      *likeReturn :: Test s -&gt; STTest s*<br/>&gt;     *at /Users/akagi/Documents/Programs/Haskell/VirtualEconomy/src/Sample.hs:26:1-36*<br/>&gt;    *‘s’ is a rigid type variable bound by*<br/>&gt;     *the type signature for:*<br/>&gt;      *likeReturn :: forall s. Test s -&gt; STTest s*<br/>&gt;     *at /Users/akagi/Documents/Programs/Haskell/VirtualEconomy/src/Sample.hs:25:1-42*<br/>&gt;    *Expected type: ST s1 (Test s1)*<br/>&gt;     *Actual type: ST s1 (Test s)*<br/>&gt;   *• In the expression: ST (\ s -&gt; (# s, x #))*<br/>&gt;    *In an equation for ‘likeReturn’:*<br/>&gt;      *likeReturn x = ST (\ s -&gt; (# s, x #))*<br/>&gt;   *• Relevant bindings include*<br/>&gt;     *x :: Test s*<br/>&gt;      *(bound at /Users/akagi/Documents/Programs/Haskell/VirtualEconomy/src/Sample.hs:26:12)*<br/>&gt;     *likeReturn :: Test s -&gt; STTest s*<br/>&gt;      *(bound at /Users/akagi/Documents/Programs/Haskell/VirtualEconomy/src/Sample.hs:26:1)*</div></div></div><div class="message event" id="message-1588409583.094600"><div class="content"><div class="summary"><div class="message__header user">as_capabl</div><div class="message__timestamp date"><a class="date" href="#message-1588409583.094600">2020-05-02&nbsp;17:53:03 +0900</a></div></div><div class="message__body description">質問の意図が取れているか自信がないのですが、<br/>• runSTTestが <code>ST s Int</code> ではなく <code>Int</code> を返せば、 <code>runSTTest ... &gt;&gt;= f</code> ではなく <code>f (runSTTest ...)</code> と書けるので恰好いい<br/>• なので、runSTTestの中でrunSTを呼び、外側のSTに紐づいたSTMArrayを参照したい<br/>というモチベーションでしょうか。内側にいるとはいえ、STのRankN多相で守られた配列を参照しようとしている事になるので、無理っぽい気がします</div></div></div><div class="message event" id="message-1588409638.094800"><div class="content"><div class="summary"><div class="message__header user">as_capabl</div><div class="message__timestamp date"><a class="date" href="#message-1588409638.094800">2020-05-02&nbsp;17:53:58 +0900</a></div></div><div class="message__body description"><pre>type STTest s = forall s. ST s (Test s)</pre><br/>この宣言ですが、右辺のforall sで新しいスコープの変数sが定義されてしまって、左辺のsは使用されないのでは。</div></div></div><div class="message event" id="message-1588410842.095100"><div class="content"><div class="summary"><div class="message__header user">akagi15</div><div class="message__timestamp date"><a class="date" href="#message-1588410842.095100">2020-05-02&nbsp;18:14:02 +0900</a></div></div><div class="message__body description">ご返信ありがとうございます.<br/>意図はそのとおりで,単に見た目が数式のとおりになるので,という話なのですが,難しそうですね.<br/><br/>たしかに,左辺のsは使用しませんね.左辺のsを消すと<br/><br/><blockquote> forall s. Test s -&gt; STTest</blockquote>となり<br/>動かない理由が直感的にもわかりやすいですね.<br/><br/>実際のコードでは,複数の時系列変数が大量につまったTest sのようなものを引き連れているので, わかりやすさと更新の速さを両立させたいですが,なかなかうまく行きません.</div></div></div><div class="message event" id="message-1588411225.095500"><div class="content"><div class="summary"><div class="message__header user">akagi15</div><div class="message__timestamp date"><a class="date" href="#message-1588411225.095500">2020-05-02&nbsp;18:20:25 +0900</a></div></div><div class="message__body description">更新を伴う大量のデータを引数に引き回す際にもともとはMapをつかっていたものをSTに変更しようとしていましたがrunSTをかませるとコードがかなり複雑になってしますので,難しいところです</div></div></div><div class="message event" id="message-1588456424.095900"><div class="content"><div class="summary"><div class="message__header user">claude0803sz</div><div class="message__timestamp date"><a class="date" href="#message-1588456424.095900">2020-05-03&nbsp;06:53:44 +0900</a></div></div><div class="message__body description">@claude0803sz has joined the channel</div></div></div><div class="message event" id="message-1588477001.096100"><div class="content"><div class="summary"><div class="message__header user">as_capabl</div><div class="message__timestamp date"><a class="date" href="#message-1588477001.096100">2020-05-03&nbsp;12:36:41 +0900</a></div></div><div class="message__body description">純粋に書いたコードをMutableに直すのが難しいのは、Haskellの泣き所の一つですね（他の言語でも難しいのは変わりないけれど、他の言語だとそもそも最初からMutableで書くので手間が発生しない）<br/>元の問題の解決方法としてはunsafe系しかなくて、具体的には <code>unsafeIOToST . unsafeSTToIO</code> でsの型を強引に合わせられるので、それを使えばなんとか……という感じです</div></div></div><div class="message event" id="message-1588647485.096500"><div class="content"><div class="summary"><div class="message__header user">aejque</div><div class="message__timestamp date"><a class="date" href="#message-1588647485.096500">2020-05-05&nbsp;11:58:05 +0900</a></div></div><div class="message__body description">@aejque has joined the channel</div></div></div><div class="message event" id="message-1588678058.096800"><div class="content"><div class="summary"><div class="message__header user">akagi15</div><div class="message__timestamp date"><a class="date" href="#message-1588678058.096800">2020-05-05&nbsp;20:27:38 +0900</a></div></div><div class="message__body description">質問させていただきます.<br/>truncateにNaNをくわせると,以下のような挙動になるのは,仕様ですか?<br/><br/><blockquote><blockquote><blockquote><blockquote>truncate 1.1<br/>1<br/><blockquote><blockquote><blockquote>truncate (1/0)<br/>179769313486231590772930519078902473361797697894230657273430081157732675805500963132708477322407536021120113879871393357658789768814416622492847430639474124377767893424865485276302219601246094119453082952085005768838150682342462881473913110540827237163350510684586298239947245938479716304835356329624224137216 <br/><blockquote><blockquote><blockquote>truncate $ log $ (-1 :: Double)<br/>-269653970229347386159395778618353710042696546841345985910145121736599013708251444699062715983611304031680170819807090036488184653221624933739271145959211186566651840137298227914453329401869141179179624428127508653257226023513694322210869665811240855745025766026879447359920868907719574457253034494436336205824</blockquote>この挙動のせいで,ループが無限に終わらないのに気づくのに一日費やしました,,笑</blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></div></div></div><div class="message event" id="message-1588678375.097800"><div class="content"><div class="summary"><div class="message__header user">akagi15</div><div class="message__timestamp date"><a class="date" href="#message-1588678375.097800">2020-05-05&nbsp;20:32:55 +0900</a></div></div><div class="message__body description">全体の処理を早くしようと,STに変更したり色々していたのですが,先程新しくした質問の方が原因でした.<br/>実時間をとってloop回していたのですが,処理が重くなるとtruncateにNaNが回る仕様になっていて,無限に処理が終わらないという...</div></div></div><div class="message event" id="message-1588678565.098200"><div class="content"><div class="summary"><div class="message__header user">igrep</div><div class="message__timestamp date"><a class="date" href="#message-1588678565.098200">2020-05-05&nbsp;20:36:05 +0900</a></div></div><div class="message__body description">質問の答えじゃなくてすみません、 <code>(1/0)</code> は <code>NaN</code> じゃなくて <code>Infinity</code> かと。</div></div></div><div class="message event" id="message-1588678619.098400"><div class="content"><div class="summary"><div class="message__header user">akagi15</div><div class="message__timestamp date"><a class="date" href="#message-1588678619.098400">2020-05-05&nbsp;20:36:59 +0900</a></div></div><div class="message__body description">あ,そうですね,質問文が InfinityやNaNでした.ご指摘ありがとうございます.</div></div></div><div class="message event" id="message-1588679210.098700"><div class="content"><div class="summary"><div class="message__header user">igrep</div><div class="message__timestamp date"><a class="date" href="#message-1588679210.098700">2020-05-05&nbsp;20:46:50 +0900</a></div></div><div class="message__body description">で、これは推測ですが、Haskellの仕様と言うよりは、浮動小数点演算の仕様な気がしますね...<br/>C言語で近いことをやった場合の結果: <a href='https://ideone.com/hQYKZG'>https://ideone.com/hQYKZG</a></div></div></div><div class="message event" id="message-1588679413.099000"><div class="content"><div class="summary"><div class="message__header user">igrep</div><div class="message__timestamp date"><a class="date" href="#message-1588679413.099000">2020-05-05&nbsp;20:50:13 +0900</a></div></div><div class="message__body description">さらに試していて気づいたんですが、結果を <code>Int</code> にしていると <code>0</code> が返るみたいです（でもこれも環境依存かもだし、あまり期待しない方がいいかも）。<br/><pre>&gt; truncate  (0.0 / 0.0) :: Int
0</pre></div></div></div><div class="message event" id="message-1588679735.099200"><div class="content"><div class="summary"><div class="message__header user">akagi15</div><div class="message__timestamp date"><a class="date" href="#message-1588679735.099200">2020-05-05&nbsp;20:55:35 +0900</a></div></div><div class="message__body description">なるほど.<br/>取りあえずのところ,NaNやInfinityを渡していたのがまずいので,<br/><blockquote>truncateSafe x<br/> | isNaN x =<br/> | isInfty x =</blockquote>的な対処でやり過ごしますが,<br/>これがあるあるではないのなら結構ハマる人多そうに感じます.</div></div></div><div class="message event" id="message-1588679744.099400"><div class="content"><div class="summary"><div class="message__header user">akagi15</div><div class="message__timestamp date"><a class="date" href="#message-1588679744.099400">2020-05-05&nbsp;20:55:44 +0900</a></div></div><div class="message__body description">ご教示ありがとうございます.</div></div></div><div class="message event" id="message-1588679940.099700"><div class="content"><div class="summary"><div class="message__header user">igrep</div><div class="message__timestamp date"><a class="date" href="#message-1588679940.099700">2020-05-05&nbsp;20:59:00 +0900</a></div></div><div class="message__body description">なるほど :bulb: 確かに見落としがちな話だと思うので、パッケージ :package: にしておくと案外受け入れてもらえるかも知れませんね！</div></div></div><div class="message event" id="message-1588680010.099900"><div class="content"><div class="summary"><div class="message__header user">akagi15</div><div class="message__timestamp date"><a class="date" href="#message-1588680010.099900">2020-05-05&nbsp;21:00:10 +0900</a></div></div><div class="message__body description">今調べてみるとceiling , floor, roundでも同様でしたね.</div></div></div><div class="message event" id="message-1588680240.100300"><div class="content"><div class="summary"><div class="message__header user">akagi15</div><div class="message__timestamp date"><a class="date" href="#message-1588680240.100300">2020-05-05&nbsp;21:04:00 +0900</a></div></div><div class="message__body description">実装をみるとproperFractionのせいのようです.<br/><a href='http://www.informatik.uni-bremen.de/~clueth/docs/ZVON/Outputprelude/RealFrac_c.html'>http://www.informatik.uni-bremen.de/~clueth/docs/ZVON/Outputprelude/RealFrac_c.html</a></div></div></div><div class="message event" id="message-1588680599.100600"><div class="content"><div class="summary"><div class="message__header user">minorinoki_haskjp</div><div class="message__timestamp date"><a class="date" href="#message-1588680599.100600">2020-05-05&nbsp;21:09:59 +0900</a></div></div><div class="message__body description">ちなみに toRational や realToFrac にも同様の問題があります</div></div></div><div class="message event" id="message-1588680688.101100"><div class="content"><div class="summary"><div class="message__header user">igrep</div><div class="message__timestamp date"><a class="date" href="#message-1588680688.101100">2020-05-05&nbsp;21:11:28 +0900</a></div></div><div class="message__body description">さすが、地雷踏み済みか... :open_mouth:</div></div></div><div class="message event" id="message-1588681538.101300"><div class="content"><div class="summary"><div class="message__header user">minorinoki_haskjp</div><div class="message__timestamp date"><a class="date" href="#message-1588681538.101300">2020-05-05&nbsp;21:25:38 +0900</a></div></div><div class="message__body description">Float と Double 間の realToFrac は最適化の有無（rewrite rule発動の有無）でNaNやInfに関する挙動が変わるという素敵仕様です:sob:</div></div></div><div class="message event" id="message-1588687918.102100"><div class="content"><div class="summary"><div class="message__header user">akagi15</div><div class="message__timestamp date"><a class="date" href="#message-1588687918.102100">2020-05-05&nbsp;23:11:58 +0900</a></div></div><div class="message__body description">STアクションAを引数にとってその内部でAをrunSTするとそれぞれが独立に評価されるので同じアクションが何度もゼロから評価されものすごいコストになることに気が付きました,<br/>いずれにせよこれをやるのはコストが高すぎるようです..</div></div></div><div class="message event" id="message-1588690622.102300"><div class="content"><div class="summary"><div class="message__header user">akagi15</div><div class="message__timestamp date"><a class="date" href="#message-1588690622.102300">2020-05-05&nbsp;23:57:02 +0900</a></div></div><div class="message__body description"><blockquote> a .+ b = (+) &lt;$&gt; a &lt;*&gt; b</blockquote>のような形で中置演算子を定義していけば,そのまま内部で使えそうだという方法が結構ニーズに近いものだったかもしれません</div></div></div><div class="message event" id="message-1588700153.102600"><div class="content"><div class="summary"><div class="message__header user">summit.isys</div><div class="message__timestamp date"><a class="date" href="#message-1588700153.102600">2020-05-06&nbsp;02:35:53 +0900</a></div></div><div class="message__body description">@summit.isys has joined the channel</div></div></div><div class="message event" id="message-1588998238.103100"><div class="content"><div class="summary"><div class="message__header user">noahzark2525</div><div class="message__timestamp date"><a class="date" href="#message-1588998238.103100">2020-05-09&nbsp;13:23:58 +0900</a></div></div><div class="message__body description">@noahzark2525 has joined the channel</div></div></div><div class="message event" id="message-1589085885.105000"><div class="content"><div class="summary"><div class="message__header user">gettaplacetogo</div><div class="message__timestamp date"><a class="date" href="#message-1589085885.105000">2020-05-10&nbsp;13:44:45 +0900</a></div></div><div class="message__body description"><code>vector</code> のbugfixを書いているんですが、 <code>INLINE</code> 関数がloopbreakerになってしまっているかってどうやって検証するんでしたっけ？</div></div></div><div class="message event" id="message-1589108590.105300"><div class="content"><div class="summary"><div class="message__header user">kibunjojosa</div><div class="message__timestamp date"><a class="date" href="#message-1589108590.105300">2020-05-10&nbsp;20:03:10 +0900</a></div></div><div class="message__body description">@kibunjojosa has joined the channel</div></div></div><div class="message event" id="message-1589111553.107400"><div class="content"><div class="summary"><div class="message__header user">maoe</div><div class="message__timestamp date"><a class="date" href="#message-1589111553.107400">2020-05-10&nbsp;20:52:33 +0900</a></div></div><div class="message__body description">-dcore-lint でINLINEプラグマが付いた関数がloop breakerになると警告が出たような気がします</div></div></div><div class="message event" id="message-1589111888.110300"><div class="content"><div class="summary"><div class="message__header user">maoe</div><div class="message__timestamp date"><a class="date" href="#message-1589111888.110300">2020-05-10&nbsp;20:58:08 +0900</a></div></div><div class="message__body description">単純にある関数がloop breakerか否かを調べるだけならCoreを出力してOcc=Loopbreakerみたいな情報が付いてるかでチェックできます</div></div></div><div class="message event" id="message-1589119549.111200"><div class="content"><div class="summary"><div class="message__header user">gettaplacetogo</div><div class="message__timestamp date"><a class="date" href="#message-1589119549.111200">2020-05-10&nbsp;23:05:49 +0900</a></div></div><div class="message__body description">なるほど。つまり、 <code>-ddump-ds</code> とかですね？</div></div></div><div class="message event" id="message-1589159628.111400"><div class="content"><div class="summary"><div class="message__header user">maoe</div><div class="message__timestamp date"><a class="date" href="#message-1589159628.111400">2020-05-11&nbsp;10:13:48 +0900</a></div></div><div class="message__body description">Occ=Loopbreakerは-ddump-simplで確認できます</div></div></div><div class="message event" id="message-1589204640.111900"><div class="content"><div class="summary"><div class="message__header user">gettaplacetogo</div><div class="message__timestamp date"><a class="date" href="#message-1589204640.111900">2020-05-11&nbsp;22:44:00 +0900</a></div></div><div class="message__body description">確かにー。ありがとうございます。</div></div></div><div class="message event" id="message-1589234370.114700"><div class="content"><div class="summary"><div class="message__header user">gettaplacetogo</div><div class="message__timestamp date"><a class="date" href="#message-1589234370.114700">2020-05-12&nbsp;06:59:30 +0900</a></div></div><div class="message__body description">Hackage / Stackage にも登録がある cabal package (non-stack project)を修正した上で、 Hackage 版ではなく修正版に依存するように、 <code>cabal exec ghc</code> (これがどれくらいまともに稼働するコマンドか理解していません)か <code>stack ghc</code> か、またはそれに類する何かを走らせるにはどうすればいいでしょうか？ <br/>ライブラリコードがインラインされた時の最適化がうまくいくように修正を掛けたつもりなので、それを適当な短いコードに対する  <code>ghc -ddump-simpl</code> で確認したいのですが、別にtestをいきなり追加したいわけではないし、自分のパッケージでもないので、いきなりそのパッケージの <code>cabal.project</code> を弄るのにも抵抗があるんですよね・・・。(いやもちろん git-managedなので弄るのに問題はないんですが)</div></div></div></div><div class="pager ui pagination menu"><a href="../../html/C5666B6BB/83.html" class="pager__previous item">Previous</a><a href="../../" class="pager__top item">Top</a></div></div></body></html>