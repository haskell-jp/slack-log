<!DOCTYPE html><html><head><meta charset="utf-8"><title>haskell-jp / questions #50</title><link rel="stylesheet" href="../../main.css" type="text/css" media="screen"></head><body><div class="ui container"><h1>haskell-jp / questions #50</h1><div class="pager ui pagination menu"><a href="../../html/C5666B6BB/49.html" class="pager__previous item">Previous</a><a href="../../" class="pager__top item">Top</a><a href="../../html/C5666B6BB/51.html" class="pager__next item">Next</a></div><div class="message_list ui feed"><div class="message event" id="message-1551953978.139900"><div class="content"><div class="summary"><div class="message__header user">cutsea110</div><div class="message__timestamp date">2019-03-07&nbsp;19:19:38 +0900</div></div><div class="message__body description">ああ失礼。私も今Settingsに到達しました.</div></div></div><div class="message event" id="message-1551955719.140100"><div class="content"><div class="summary"><div class="message__header user">cutsea110</div><div class="message__timestamp date">2019-03-07&nbsp;19:48:39 +0900</div></div><div class="message__body description">GhcMonadのgetSessionDynFlagsかな</div></div></div><div class="message event" id="message-1551956556.140300"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;20:02:36 +0900</div></div><div class="message__body description">このコードをかっこよくするにはどのようにすればいいのでしょうか？<br/><code>all isJust</code> でチェックしてから <code>map fromJust</code> しているところなどがとてもダサく感じています。<br/><code>&gt;&gt;=</code> を繋げるみたいな感じでかっこよく書きたいです。<br/>よろしくお願い致します。</div></div></div><div class="message event" id="message-1551956835.140600"><div class="content"><div class="summary"><div class="message__header user">a_kirisaki</div><div class="message__timestamp date">2019-03-07&nbsp;20:07:15 +0900</div></div><div class="message__body description">多分 <code>Data.Maybe</code> にあるこの関数でイケると思います <a href='http://hackage.haskell.org/package/base-4.12.0.0/docs/Data-Maybe.html#v:catMaybes'>http://hackage.haskell.org/package/base-4.12.0.0/docs/Data-Maybe.html#v:catMaybes</a></div></div></div><div class="message event" id="message-1551956867.140800"><div class="content"><div class="summary"><div class="message__header user">cutsea110</div><div class="message__timestamp date">2019-03-07&nbsp;20:07:47 +0900</div></div><div class="message__body description">あーいえ,問題になるわけじゃなく今パフォーマンスチューニングするためにコンパイラの最適化がどうなってるかイチから調べているところなだけです.ありがとうございます.</div></div></div><div class="message event" id="message-1551956946.141000"><div class="content"><div class="summary"><div class="message__header user">a_kirisaki</div><div class="message__timestamp date">2019-03-07&nbsp;20:09:06 +0900</div></div><div class="message__body description">おっと、途中で <code>values</code> が増えてたので期待する動作がわからなく……</div></div></div><div class="message event" id="message-1551957907.141200"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;20:25:07 +0900</div></div><div class="message__body description">説明不足ですみません！<br/>keys、もしくはvaluesに一つでもNothingが入っていたらNothingを返したいんです</div></div></div><div class="message event" id="message-1551958401.141500"><div class="content"><div class="summary"><div class="message__header user">cutsea110</div><div class="message__timestamp date">2019-03-07&nbsp;20:33:21 +0900</div></div><div class="message__body description">foo xs ys = sequenceA $ zipWith f xs ys<br/>  where<br/>    f mx my = do { x &lt;- mx; y &lt;- my; return (x, y) }</div></div></div><div class="message event" id="message-1551958406.141700"><div class="content"><div class="summary"><div class="message__header user">cutsea110</div><div class="message__timestamp date">2019-03-07&nbsp;20:33:26 +0900</div></div><div class="message__body description">これでどうでしょ?</div></div></div><div class="message event" id="message-1551958414.141900"><div class="content"><div class="summary"><div class="message__header user">hiroto.shioi</div><div class="message__timestamp date">2019-03-07&nbsp;20:33:34 +0900</div></div><div class="message__body description"><pre>
get :: [Maybe a] -&gt; Maybe [a]
get = undefined

some :: [Maybe Char] -&gt; [Maybe Int] -&gt; Maybe (Map Char Int)
some keys values = do
    k &lt;- get keys
    v &lt;- get values
    return Map.fromList $ zip k v
</pre></div></div></div><div class="message event" id="message-1551958487.142200"><div class="content"><div class="summary"><div class="message__header user">cutsea110</div><div class="message__timestamp date">2019-03-07&nbsp;20:34:47 +0900</div></div><div class="message__body description">λ&gt; keys<br/>[Just "a",Just "b",Nothing]<br/>λ&gt; values<br/>[Just 1,Just 2,Just 3]<br/>λ&gt; foo keys values<br/>Nothing<br/>λ&gt; keys<br/>[Just "a",Just "b",Just "c"]<br/>λ&gt; values<br/>[Just 1,Just 2,Just 3]<br/>λ&gt; foo keys values<br/>Just [("a",1),("b",2),("c",3)]</div></div></div><div class="message event" id="message-1551958491.142400"><div class="content"><div class="summary"><div class="message__header user">cutsea110</div><div class="message__timestamp date">2019-03-07&nbsp;20:34:51 +0900</div></div><div class="message__body description">こうなる.</div></div></div><div class="message event" id="message-1551958541.142600"><div class="content"><div class="summary"><div class="message__header user">cutsea110</div><div class="message__timestamp date">2019-03-07&nbsp;20:35:41 +0900</div></div><div class="message__body description">codeどうやって貼り付けるんだ (じじぃまるだし</div></div></div><div class="message event" id="message-1551958633.143000"><div class="content"><div class="summary"><div class="message__header user">kazu</div><div class="message__timestamp date">2019-03-07&nbsp;20:37:13 +0900</div></div><div class="message__body description">とりあえず、"```"で囲む。</div></div></div><div class="message event" id="message-1551958730.143200"><div class="content"><div class="summary"><div class="message__header user">cutsea110</div><div class="message__timestamp date">2019-03-07&nbsp;20:38:50 +0900</div></div><div class="message__body description">mdキホーでしたか.<br/><pre>
foo xs ys = sequenceA $ zipWith f xs ys
  where
    f mx my = do { x &lt;- mx; y &lt;- my; return (x, y) }
</pre></div></div></div><div class="message event" id="message-1551958771.143500"><div class="content"><div class="summary"><div class="message__header user">as_capabl</div><div class="message__timestamp date">2019-03-07&nbsp;20:39:31 +0900</div></div><div class="message__body description">cutsea110さんの <code>f</code> を <code>liftA2 (,)</code> で書けば1行で行ける</div></div></div><div class="message event" id="message-1551958808.143700"><div class="content"><div class="summary"><div class="message__header user">cutsea110</div><div class="message__timestamp date">2019-03-07&nbsp;20:40:08 +0900</div></div><div class="message__body description">おおステキ</div></div></div><div class="message event" id="message-1551959085.143900"><div class="content"><div class="summary"><div class="message__header user">cutsea110</div><div class="message__timestamp date">2019-03-07&nbsp;20:44:45 +0900</div></div><div class="message__body description">あ、ちがうちがう. fのコンテキストはMaybeなのでmxやmyはJust 1とかNothing.<br/>liftA2したら直積作っちゃうな.</div></div></div><div class="message event" id="message-1551959314.144100"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;20:48:34 +0900</div></div><div class="message__body description">す、すごい…！<br/>みなさんありがとうございます！<br/>こんなにかっこよく書けるんですね！！（見たことない関数がある…seequenceA…）</div></div></div><div class="message event" id="message-1551959427.146100"><div class="content"><div class="summary"><div class="message__header user">kazu</div><div class="message__timestamp date">2019-03-07&nbsp;20:50:27 +0900</div></div><div class="message__body description">オリジナルのコードが一番分かりやすいので、変にかっこよく書く必要はないと思いますよ。</div></div></div><div class="message event" id="message-1551959473.146300"><div class="content"><div class="summary"><div class="message__header user">cutsea110</div><div class="message__timestamp date">2019-03-07&nbsp;20:51:13 +0900</div></div><div class="message__body description">sequenceAはsequenceで良さげ.</div></div></div><div class="message event" id="message-1551959521.146900"><div class="content"><div class="summary"><div class="message__header user">kazu</div><div class="message__timestamp date">2019-03-07&nbsp;20:52:01 +0900</div></div><div class="message__body description">そりゃそうだ。</div></div></div><div class="message event" id="message-1551959582.148300"><div class="content"><div class="summary"><div class="message__header user">kazu</div><div class="message__timestamp date">2019-03-07&nbsp;20:53:02 +0900</div></div><div class="message__body description">リストが長く効率を求めるなら、再帰で書くといいでしょう。</div></div></div><div class="message event" id="message-1551959633.148500"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;20:53:53 +0900</div></div><div class="message__body description">確かにオリジナルは一番分かりやすいですね！</div></div></div><div class="message event" id="message-1551959641.148700"><div class="content"><div class="summary"><div class="message__header user">hiroto.shioi</div><div class="message__timestamp date">2019-03-07&nbsp;20:54:01 +0900</div></div><div class="message__body description">自分はこうなった。確かにかずさんのいうとおり、これだと長いリストだと危ない。<br/><pre>
some :: [Maybe String] -&gt; [Maybe Int] -&gt; Maybe (M.Map String Int)
some keys values = do
    k &lt;- sequence keys
    v &lt;- sequence values
    return $ M.fromList $ zip k v

</pre></div></div></div><div class="message event" id="message-1551959743.149000"><div class="content"><div class="summary"><div class="message__header user">as_capabl</div><div class="message__timestamp date">2019-03-07&nbsp;20:55:43 +0900</div></div><div class="message__body description">確かに、allとfromListでリストを二回参照するとスペースリークするので、zip(With)でくっつけてから回すか再帰で2つのリストを同時にマッチしないとダメなのには注意です</div></div></div><div class="message event" id="message-1551959746.149200"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;20:55:46 +0900</div></div><div class="message__body description">おお！こちらはわかりやすいのにかっこいいですね！</div></div></div><div class="message event" id="message-1551959874.149400"><div class="content"><div class="summary"><div class="message__header user">mizunashi-mana</div><div class="message__timestamp date">2019-03-07&nbsp;20:57:54 +0900</div></div><div class="message__body description">GhcMonadって単にGHCを起動して指定された場所のsettingsファイルを読みに行く実装しかなくないですか?</div></div></div><div class="message event" id="message-1551959887.149600"><div class="content"><div class="summary"><div class="message__header user">hiroto.shioi</div><div class="message__timestamp date">2019-03-07&nbsp;20:58:07 +0900</div></div><div class="message__body description">多相にするとこうなる<br/><br/><pre>
some ::　(Ord key) =&gt; [Maybe key] -&gt; [Maybe value] -&gt; Maybe (M.Map key value)
some keys values = do
    k &lt;- sequence keys
    v &lt;- sequence values
    return $ M.fromList $ zip k v

</pre></div></div></div><div class="message event" id="message-1551959946.149800"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;20:59:06 +0900</div></div><div class="message__body description">2回参照するだけでもスペースリークって発生してしまうのですか…知りませんでした・・・</div></div></div><div class="message event" id="message-1551960074.150000"><div class="content"><div class="summary"><div class="message__header user">as_capabl</div><div class="message__timestamp date">2019-03-07&nbsp;21:01:14 +0900</div></div><div class="message__body description">これのREADMEの解説が分かりやすいです&gt;リーク <a href='http://hackage.haskell.org/package/foldl'>http://hackage.haskell.org/package/foldl</a></div></div></div><div class="message event" id="message-1551960239.150400"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;21:03:59 +0900</div></div><div class="message__body description">熟読します…！</div></div></div><div class="message event" id="message-1551960341.150600"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;21:05:41 +0900</div></div><div class="message__body description">リストが長いと危ないというのはsequenceが原因ということですか？？</div></div></div><div class="message event" id="message-1551960407.150800"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;21:06:47 +0900</div></div><div class="message__body description">レベルが低く皆さんの会話についていけず…質問ばかりですみません…</div></div></div><div class="message event" id="message-1551960469.151000"><div class="content"><div class="summary"><div class="message__header user">autotaker</div><div class="message__timestamp date">2019-03-07&nbsp;21:07:49 +0900</div></div><div class="message__body description">リストの長さが同じことが仮定できるなら<br/><pre>
fmap M.fromList $ zipWithM (liftA2 (,)) keys values
</pre><br/>でもいいですね</div></div></div><div class="message event" id="message-1551960524.151200"><div class="content"><div class="summary"><div class="message__header user">as_capabl</div><div class="message__timestamp date">2019-03-07&nbsp;21:08:44 +0900</div></div><div class="message__body description">sequence, sum, foldr, allとかの「リストを全部なめる関数」は、1回だけ呼ぶ分には遅延評価で上手いこと「生成→消費」のループを回して、余計なメモリを使わずに処理できるんですが、</div></div></div><div class="message event" id="message-1551960587.151400"><div class="content"><div class="summary"><div class="message__header user">as_capabl</div><div class="message__timestamp date">2019-03-07&nbsp;21:09:47 +0900</div></div><div class="message__body description">この類の関数を2回以上呼んでしまうと、生成した要素を捨てずに覚えておかないといけないので、リストの長さ分のメモリを使ってしまうんですね</div></div></div><div class="message event" id="message-1551960669.151600"><div class="content"><div class="summary"><div class="message__header user">as_capabl</div><div class="message__timestamp date">2019-03-07&nbsp;21:11:09 +0900</div></div><div class="message__body description">（さっきのページそれほど親切に書いてないですね、所詮ライブラリの説明なので）</div></div></div><div class="message event" id="message-1551960695.151800"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;21:11:35 +0900</div></div><div class="message__body description">なるほど…知りませんでした…！！</div></div></div><div class="message event" id="message-1551960780.152100"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;21:13:00 +0900</div></div><div class="message__body description">@autotaker おお！そんな書き方もできるんですね！！</div></div></div><div class="message event" id="message-1551961196.152300"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;21:19:56 +0900</div></div><div class="message__body description">先程のリンクを見ているのですが ( <a href='http://hackage.haskell.org/package/foldl'>http://hackage.haskell.org/package/foldl</a> )<br/><code>sumAndLength xs = (sum xs, length xs)</code><br/>これを見るとlength xsが終わった段階でxsは必要なくなってガベージコレクトの対象になるように見えるのですが、実際は違うのはなぜなのでしょうか？</div></div></div><div class="message event" id="message-1551961306.152700"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;21:21:46 +0900</div></div><div class="message__body description">あ、length xsが終わったらxsは必要なくなるけどsum xsの実行時点では次のlength xsがあるからxsを捨てられないということですか？</div></div></div><div class="message event" id="message-1551961455.153000"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;21:24:15 +0900</div></div><div class="message__body description">なるほど！！</div></div></div><div class="message event" id="message-1551961564.153200"><div class="content"><div class="summary"><div class="message__header user">shogo.otake</div><div class="message__timestamp date">2019-03-07&nbsp;21:26:04 +0900</div></div><div class="message__body description">なんとなくわかったようなわかってないような…<br/>それとリストが長いと危険というのはどう関係するのでしょうか？<br/>長いリストを持っている時点でメモリ上に長いリストが展開されているわけではないのでしょうか？</div></div></div><div class="message event" id="message-1551962221.153400"><div class="content"><div class="summary"><div class="message__header user">as_capabl</div><div class="message__timestamp date">2019-03-07&nbsp;21:37:01 +0900</div></div><div class="message__body description"><blockquote>長いリストを持っている時点でメモリ上に長いリストが展開されている</blockquote>それはその通りです。<br/>問題になるのは、たとえばkeysが<br/><br/><pre>
let keys = [Just (show n )| n &lt;- [1..] ]
</pre><br/><br/>のようにメモリに展開されていない状態で処理を始める場合なので、結構限られたケースかもしれません。</div></div></div><div class="message event" id="message-1551962275.153700"><div class="content"><div class="summary"><div class="message__header user">autotaker</div><div class="message__timestamp date">2019-03-07&nbsp;21:37:55 +0900</div></div><div class="message__body description">今回のケースでは最終的にできる <code>M.Map String Int</code>がO(n)のメモリを消費するのであまり気にしなくてもいい気がします。</div></div></div><div class="message event" id="message-1551962487.154100"><div class="content"><div class="summary"><div class="message__header user">koyama</div><div class="message__timestamp date">2019-03-07&nbsp;21:41:27 +0900</div></div><div class="message__body description">＞リストの長さが同じことが仮定できるなら<br/>この仮定は必要なのでしょうか？ zipシリーズは長さがずれているなら短い方に合わせて処理しそうですが…</div></div></div><div class="message event" id="message-1551962621.154300"><div class="content"><div class="summary"><div class="message__header user">as_capabl</div><div class="message__timestamp date">2019-03-07&nbsp;21:43:41 +0900</div></div><div class="message__body description">一番始めのコードの場合、長い方のリストの末尾にNothingが入っててもNothingになるので、厳密にいうと動きが違うんですよね……</div></div></div><div class="message event" id="message-1551962652.154500"><div class="content"><div class="summary"><div class="message__header user">koyama</div><div class="message__timestamp date">2019-03-07&nbsp;21:44:12 +0900</div></div><div class="message__body description">ああなるほど</div></div></div><div class="message event" id="message-1551962704.154700"><div class="content"><div class="summary"><div class="message__header user">hiroto.shioi</div><div class="message__timestamp date">2019-03-07&nbsp;21:45:04 +0900</div></div><div class="message__body description">危険という表現は微妙だったかもしれない！<br/>今回の場合なら、２つのリストを同時に辿ったほうが効率いいんじゃないかなーって</div></div></div></div><div class="pager ui pagination menu"><a href="../../html/C5666B6BB/49.html" class="pager__previous item">Previous</a><a href="../../" class="pager__top item">Top</a><a href="../../html/C5666B6BB/51.html" class="pager__next item">Next</a></div></div></body></html>