<!DOCTYPE html><html><head><meta charset="utf-8"><title>haskell-jp / questions #94</title><link rel="stylesheet" href="../../main.css" type="text/css" media="screen"></head><body><div class="ui container"><h1>haskell-jp / questions #94</h1><div class="pager ui pagination menu"><a href="../../html/C5666B6BB/93.html" class="pager__previous item">Previous</a><a href="../../" class="pager__top item">Top</a></div><div class="message_list ui feed"><div class="message event" id="message-1606974568.195400"><div class="content"><div class="summary"><div class="message__header user">kazu</div><div class="message__timestamp date"><a class="date" href="#message-1606974568.195400">2020-12-03&nbsp;14:49:28 +0900</a></div></div><div class="message__body description">昔の GHC だと、UNPACK で  Strict な小さな値は、ポインターではなく即値が格納されるようになります。<br/>しかし、現在の GHC は UNPACK は必要なく、Strict で小さければ、既値が格納されます。</div></div></div><div class="message event" id="message-1606981265.196400"><div class="content"><div class="summary"><div class="message__header user">wasabi.nvim.st</div><div class="message__timestamp date"><a class="date" href="#message-1606981265.196400">2020-12-03&nbsp;16:41:05 +0900</a></div></div><div class="message__body description">unpackされるかどうか自動的に判断されるということですね、ありがとうございます！</div></div></div><div class="message event" id="message-1607305195.196800"><div class="content"><div class="summary"><div class="message__header user">hatsugai</div><div class="message__timestamp date"><a class="date" href="#message-1607305195.196800">2020-12-07&nbsp;10:39:55 +0900</a></div></div><div class="message__body description">@hatsugai has joined the channel</div></div></div><div class="message event" id="message-1607407240.197100"><div class="content"><div class="summary"><div class="message__header user">yusuke.nakayama1218</div><div class="message__timestamp date"><a class="date" href="#message-1607407240.197100">2020-12-08&nbsp;15:00:40 +0900</a></div></div><div class="message__body description">@yusuke.nakayama1218 has joined the channel</div></div></div><div class="message event" id="message-1607494891.205200"><div class="content"><div class="summary"><div class="message__header user">lotz</div><div class="message__timestamp date"><a class="date" href="#message-1607494891.205200">2020-12-09&nbsp;15:21:31 +0900</a></div></div><div class="message__body description">質問させてください :raising_hand:<br/><a href='https://hackage.haskell.org/package/vector-sized-1.4.3/docs/Data-Vector-Sized.html'>vector-sizedの型レベルで長さを持つVector</a>の以下のような型クラスのインスタンスを定義したいのですがやり方が分からず困ってます :cry:<br/>うまいやり方を知っている or 一緒に悩んでくれる人がいたらコメントしていただけると嬉しいです :pray:<br/>（動かないですが書きたいコード）<br/><pre>import qualified Data.Vector.Sized as V

class Raccum a where
  raccum :: a -&gt; a

instance Num a =&gt; Raccum (Vector 1 a) where
  raccum = id

instance Num a =&gt; Raccum (Vector m a) where
  raccum v = V.cons (V.sum v) (raccum $ V.tail v)</pre><br/>一応以下のように試行錯誤したのですが成功せず、、<br/>Vector n a の関数実装に Vector (n-1) a の関数を使っているところの型推論がうまく行かないので<br/>• ↑を解決するためにUndecidableInstancesを使って（あまり使いたくない…）型クラス制約を <code>(Num a, m ~ (1+n), Raccum (Vector n a)) =&gt;</code> のように変更するとコンパイルは通るが実行時に <code>Overlapping instances</code> で怒られる<br/>• ↑仕方ないので以下のように一つの実装にまとめると <code>Couldn't match type '1' with '0' arising from a use of 'raccum'</code> と怒られる<br/><pre>instance (KnownNat m, KnownNat n, Num a, m ~ (1+n), Raccum (Vector n a)) =&gt; Raccum (Vector m a) where
  raccum v
    | m == 1    = v
    | otherwise = V.cons (V.sum v) (raccum $ V.tail v)
    where m = natVal (Proxy @m)</pre></div></div></div><div class="message event" id="message-1607495010.205300"><div class="content"><div class="summary"><div class="message__header user">lotz</div><div class="message__timestamp date"><a class="date" href="#message-1607495010.205300">2020-12-09&nbsp;15:23:30 +0900</a></div></div><div class="message__body description">※`raccum` を実装したいわけではなくこの例のようにGHCの型レベル自然数に対して帰納的に型クラスのインスタンスを実装する方法を知りたいと思っています</div></div></div><div class="message event" id="message-1607496050.205500"><div class="content"><div class="summary"><div class="message__header user">lotz</div><div class="message__timestamp date"><a class="date" href="#message-1607496050.205500">2020-12-09&nbsp;15:40:50 +0900</a></div></div><div class="message__body description">:memo: こう書けても良さそうなんですがこれは <code>Illegal type synonym family application 'n + 1' in instance</code> と怒られるんですよね、、<br/><pre>instance (Raccum (Vector n a), Num a) =&gt; Raccum (Vector (n+1) a) where
  raccum v = V.cons (V.sum v) (raccum $ V.tail v)</pre></div></div></div><div class="message event" id="message-1607497039.205700"><div class="content"><div class="summary"><div class="message__header user">minorinoki_haskjp</div><div class="message__timestamp date"><a class="date" href="#message-1607497039.205700">2020-12-09&nbsp;15:57:19 +0900</a></div></div><div class="message__body description"><a href='https://qiita.com/mod_poppo/items/3a37424d299a9f71b757'>https://qiita.com/mod_poppo/items/3a37424d299a9f71b757</a> に書いたように、GHCのNatは帰納的な定義ではないので、真っ当な方法でそういう関数を定義することはできません。</div></div></div><div class="message event" id="message-1607497151.206000"><div class="content"><div class="summary"><div class="message__header user">minorinoki_haskjp</div><div class="message__timestamp date"><a class="date" href="#message-1607497151.206000">2020-12-09&nbsp;15:59:11 +0900</a></div></div><div class="message__body description">unsafeな手段を厭わないのであれば、<br/><pre>
data NatCons (n :: Nat) where
  Zero :: NatCons 0
  Succ :: (KnownNat n, m ~ (1 + n)) =&gt; Proxy n -&gt; NatCons m

{-# NOINLINE natCons #-}
natCons :: KnownNat n =&gt; Proxy n -&gt; NatCons n
natCons proxy = case sameNat proxy (Proxy :: Proxy 0) of
                  Just Refl -&gt; Zero
                  Nothing -&gt; case someNatVal (natVal proxy - 1) of
                               SomeNat proxy' -&gt; unsafeCoerce (Succ proxy')</pre><br/>という補助関数を用意してやれば自然数が0か後続者かで場合分けできるようになります。（完全なコードは <a href='https://gist.github.com/minoki/08b5825e249ae5642a6236a5f5adf702'>https://gist.github.com/minoki/08b5825e249ae5642a6236a5f5adf702</a>）</div></div></div><div class="message event" id="message-1607497223.206200"><div class="content"><div class="summary"><div class="message__header user">minorinoki_haskjp</div><div class="message__timestamp date"><a class="date" href="#message-1607497223.206200">2020-12-09&nbsp;16:00:23 +0900</a></div></div><div class="message__body description">試してませんが、自分でunsafeなコードを書きたくないのであれば、singletonsとcompiler pluginの組み合わせでどうにかできるかもしれません。</div></div></div><div class="message event" id="message-1607497435.206400"><div class="content"><div class="summary"><div class="message__header user">lotz</div><div class="message__timestamp date"><a class="date" href="#message-1607497435.206400">2020-12-09&nbsp;16:03:55 +0900</a></div></div><div class="message__body description">Nat自体が帰納的に定義されてないことに起因してますよね、、<br/>調べてる時にこちらの記事も読ませていただきました! :pray:<br/><br/>実装教えていただきありがとうございます!! unsafeな方法でも動かす方法が全く思いつかなかったのでめちゃくちゃありがたいです :innocent:<br/><br/>singletons + pluginですか :memo:<br/>singletons 使ったことがないので考える良い機会になりそうです :arigatougozaimasu: :pray:</div></div></div><div class="message event" id="message-1607503731.206600"><div class="content"><div class="summary"><div class="message__header user">minorinoki_haskjp</div><div class="message__timestamp date"><a class="date" href="#message-1607503731.206600">2020-12-09&nbsp;17:48:51 +0900</a></div></div><div class="message__body description">singletons + compiler plugin を使った版も書いてみましたが、結局痒いところに手が届かなくてunsafeCoerceを使ってしまう羽目になりました <a href='https://gist.github.com/minoki/08b5825e249ae5642a6236a5f5adf702#file-sing-hs'>https://gist.github.com/minoki/08b5825e249ae5642a6236a5f5adf702#file-sing-hs</a><br/>（更新：ghc-typelits-knownnatを入れた意義が微妙なことになっていたので直しました）</div></div></div><div class="message event" id="message-1607503967.206800"><div class="content"><div class="summary"><div class="message__header user">lotz</div><div class="message__timestamp date"><a class="date" href="#message-1607503967.206800">2020-12-09&nbsp;17:52:47 +0900</a></div></div><div class="message__body description">すごい！めちゃくちゃ勉強になります :pray: :arigatougozaimasu:</div></div></div><div class="message event" id="message-1607505408.207200"><div class="content"><div class="summary"><div class="message__header user">lotz</div><div class="message__timestamp date"><a class="date" href="#message-1607505408.207200">2020-12-09&nbsp;18:16:48 +0900</a></div></div><div class="message__body description">本来書きたかったコードも頂いたコードを参考に無事実装できました :pray: :pray: :pray:</div></div></div><div class="message event" id="message-1607610810.207800"><div class="content"><div class="summary"><div class="message__header user">kzk0693</div><div class="message__timestamp date"><a class="date" href="#message-1607610810.207800">2020-12-10&nbsp;23:33:30 +0900</a></div></div><div class="message__body description">@kzk0693 has joined the channel</div></div></div><div class="message event" id="message-1608140827.210300"><div class="content"><div class="summary"><div class="message__header user">9647142</div><div class="message__timestamp date"><a class="date" href="#message-1608140827.210300">2020-12-17&nbsp;02:47:07 +0900</a></div></div><div class="message__body description">HakyllでBinaryのインスタンスじゃないもののsnapshot的なものは取れないんでしょうか。LucidのHtmlTのコンストラクタがエクスポートされてなくてStandaloneDerivingでもBinary(Generic)のインスタンスにできず...</div></div></div><div class="message event" id="message-1608141270.210500"><div class="content"><div class="summary"><div class="message__header user">9647142</div><div class="message__timestamp date"><a class="date" href="#message-1608141270.210500">2020-12-17&nbsp;02:54:30 +0900</a></div></div><div class="message__body description">本当にsnapshot取りたかったのは取りたかったのはタイトルの部分ですよね? タイトルだけsnapshot取って解決</div></div></div><div class="message event" id="message-1608163096.210800"><div class="content"><div class="summary"><div class="message__header user">igrep</div><div class="message__timestamp date"><a class="date" href="#message-1608163096.210800">2020-12-17&nbsp;08:58:16 +0900</a></div></div><div class="message__body description">Monad TransformerをBinaryのインスタンスにしてシリアライズするのは原理的に難しそうなので、やるとしたら一旦生の文字列（TextでもByteStringでも）に変えるしかなかったのではないかと</div></div></div><div class="message event" id="message-1608179841.211700"><div class="content"><div class="summary"><div class="message__header user">hexirp</div><div class="message__timestamp date"><a class="date" href="#message-1608179841.211700">2020-12-17&nbsp;13:37:21 +0900</a></div></div><div class="message__body description">リストを codensity 変換したものって <code>forall r. m r -&gt; (a -&gt; r -&gt; m r) -&gt; m r</code> でいいんですよね。これってモナドにするときに <code>Monad m</code> が必要ということで合ってますよね？</div></div></div><div class="message event" id="message-1608180457.211800"><div class="content"><div class="summary"><div class="message__header user">hexirp</div><div class="message__timestamp date"><a class="date" href="#message-1608180457.211800">2020-12-17&nbsp;13:47:37 +0900</a></div></div><div class="message__body description"><a href='https://stackoverflow.com/questions/45334985/when-to-use-cps-vs-codensity-vs-reflection-without-remorse-in-haskell'>https://stackoverflow.com/questions/45334985/when-to-use-cps-vs-codensity-vs-reflection-without-remorse-in-haskell</a> によると、これは「 codensity 変換」ではなく「 CPS 変換」なようです。</div></div></div><div class="message event" id="message-1608184533.212100"><div class="content"><div class="summary"><div class="message__header user">fumieval</div><div class="message__timestamp date"><a class="date" href="#message-1608184533.212100">2020-12-17&nbsp;14:55:33 +0900</a></div></div><div class="message__body description">mはなくてもよく、foldrにリストを部分適用した型になります。もしLogicTのようにモナドを埋め込むなら、`(a → m r → m r) → m r → m r`ですね</div></div></div><div class="message event" id="message-1608184883.212900"><div class="content"><div class="summary"><div class="message__header user">hexirp</div><div class="message__timestamp date"><a class="date" href="#message-1608184883.212900">2020-12-17&nbsp;15:01:23 +0900</a></div></div><div class="message__body description">ありがとうございます！</div></div></div><div class="message event" id="message-1609219658.215400"><div class="content"><div class="summary"><div class="message__header user">michaeleverydaysunday</div><div class="message__timestamp date"><a class="date" href="#message-1609219658.215400">2020-12-29&nbsp;14:27:38 +0900</a></div></div><div class="message__body description">@michaeleverydaysunday has joined the channel</div></div></div><div class="message event" id="message-1609596543.217100"><div class="content"><div class="summary"><div class="message__header user">U01HPB51LLE</div><div class="message__timestamp date"><a class="date" href="#message-1609596543.217100">2021-01-02&nbsp;23:09:03 +0900</a></div></div><div class="message__body description">@U01HPB51LLE has joined the channel</div></div></div></div><div class="pager ui pagination menu"><a href="../../html/C5666B6BB/93.html" class="pager__previous item">Previous</a><a href="../../" class="pager__top item">Top</a></div></div></body></html>