<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>haskell-jp / questions #68</title>
<link rel="stylesheet" href="../../main.css" type="text/css" media="screen">
</head>
<body>
  <div class="ui container">
    <h1>haskell-jp / questions #68</h1>
    <div class="ui pagination menu">
      <a href="../../html/C5666B6BB/67.html" class="item">Previous</a>
      <a href="../../" class="item">Top</a>
      <a href="../../html/C5666B6BB/69.html" class="item">Next</a>
    </div>
    <div class="ui feed">
      <div class="event" id="message-1566219854.115200">
        <div class="content">
          <div class="summary">
            <div class="user">k.marumaru524</div>
            <div class="date"><a class="date" href="#message-1566219854.115200">2019-08-19 22:04:14 +0900</a></div>
          </div>
          <div class="description">@igrep<br/>あ！！spacesがspaceになっているのが原因でした..<br/>ありがとうございます<br/>前々からspacesはやたら出てくるなぁと感じていたので教えていただいたものを使うとだいぶスッキリ書けました</div>
        </div>
      </div>
      <div class="event" id="message-1566219992.115500">
        <div class="content">
          <div class="summary">
            <div class="user">k.marumaru524</div>
            <div class="date"><a class="date" href="#message-1566219992.115500">2019-08-19 22:06:32 +0900</a></div>
          </div>
          <div class="description">@as_capabl これ、やりたかったけど書き方がわからなくて断念したものに近いです！ありがとうございます<br/><br/>ちなみにこんな感じになりました<br/><a href='https://github.com/mrsekut/plp-hs/commit/7f2a2425244ae40f028d9b1fa3cde321726399dc'>https://github.com/mrsekut/plp-hs/commit/7f2a2425244ae40f028d9b1fa3cde321726399dc</a></div>
        </div>
      </div>
      <div class="event" id="message-1566220077.115700">
        <div class="content">
          <div class="summary">
            <div class="user">k.marumaru524</div>
            <div class="date"><a class="date" href="#message-1566220077.115700">2019-08-19 22:07:57 +0900</a></div>
          </div>
          <div class="description">@takenobu.hs<br/>choiceとchainl1は初見でした<br/>早速試してみます<br/>ありがとうございます！</div>
        </div>
      </div>
      <div class="event" id="message-1566235611.116600">
        <div class="content">
          <div class="summary">
            <div class="user">k.marumaru524</div>
            <div class="date"><a class="date" href="#message-1566235611.116600">2019-08-20 02:26:51 +0900</a></div>
          </div>
          <div class="description">chainl1ヤバいですね..</div>
        </div>
      </div>
      <div class="event" id="message-1566252727.117000">
        <div class="content">
          <div class="summary">
            <div class="user">igrep</div>
            <div class="date"><a class="date" href="#message-1566252727.117000">2019-08-20 07:12:07 +0900</a></div>
          </div>
          <div class="description">おまけにひけらかし: Megaparsecには、chainlを便利にしたmakeExprParserというのがあります<br/><a href='https://hackage.haskell.org/package/megaparsec-6.4.0/docs/Text-Megaparsec-Expr.html'>https://hackage.haskell.org/package/megaparsec-6.4.0/docs/Text-Megaparsec-Expr.html</a></div>
        </div>
      </div>
      <div class="event" id="message-1566314797.117600">
        <div class="content">
          <div class="summary">
            <div class="user">k.marumaru524</div>
            <div class="date"><a class="date" href="#message-1566314797.117600">2019-08-21 00:26:37 +0900</a></div>
          </div>
          <div class="description">なるほど！！<br/>Parsecを拡張(?)したAuttoparsecやMegaparsecなるものがあるのですね<br/>初めて知りました<br/>ありがとうございます！<br/>makeExprParser、ちょっと調べてみます</div>
        </div>
      </div>
      <div class="event" id="message-1566320100.118000">
        <div class="content">
          <div class="summary">
            <div class="user">igrep</div>
            <div class="date"><a class="date" href="#message-1566320100.118000">2019-08-21 01:55:00 +0900</a></div>
          </div>
          <div class="description">Megaparsecについてはそうです。Parsecのイケてないところをいろいろ改善するために作られたライブラリーなので。<br/>Attoparsecについては、Parsecとちょっと方向性が違っていて、詳しいエラーメッセージを出せない代わりに速度を高めています</div>
        </div>
      </div>
      <div class="event" id="message-1566320938.118200">
        <div class="content">
          <div class="summary">
            <div class="user">k.marumaru524</div>
            <div class="date"><a class="date" href="#message-1566320938.118200">2019-08-21 02:08:58 +0900</a></div>
          </div>
          <div class="description">なるほど、それぞれ目的が異なるのですね<br/>なにも知らないですが、処理速度と詳しいエラーが出せないことがトレードオフになるのが少し不思議に感じます</div>
        </div>
      </div>
      <div class="event" id="message-1566365661.118400">
        <div class="content">
          <div class="summary">
            <div class="user">igrep</div>
            <div class="date"><a class="date" href="#message-1566365661.118400">2019-08-21 14:34:21 +0900</a></div>
          </div>
          <div class="description">ここでいう「詳しいエラーメッセージ」とはエラーが発生した位置を含んでいる、という意味です。</div>
        </div>
      </div>
      <div class="event" id="message-1566394109.118700">
        <div class="content">
          <div class="summary">
            <div class="user">takenobu.hs</div>
            <div class="date"><a class="date" href="#message-1566394109.118700">2019-08-21 22:28:29 +0900</a></div>
          </div>
          <div class="description">既知かも知れませんが参考までに、Megaparsecなどの情報です。<br/><br/>Bigmoonさんのところの記事（日本語）<br/><a href='https://haskell.e-bigmoon.com/posts/2019/07-14-megaparsec-tutorial.html'>https://haskell.e-bigmoon.com/posts/2019/07-14-megaparsec-tutorial.html</a><br/><br/>Switch from Parsec to Megaparsec（英語）<br/><a href='https://markkarpov.com/megaparsec/switch-from-parsec-to-megaparsec.html'>https://markkarpov.com/megaparsec/switch-from-parsec-to-megaparsec.html</a><br/><br/>Mizunashiさんの、いろいろなパーサまとめ記事もあり。<br/><a href='https://qiita.com/Mizunashi_Mana/items/115855bf2af9b9970198'>https://qiita.com/Mizunashi_Mana/items/115855bf2af9b9970198</a></div>
        </div>
      </div>
      <div class="event" id="message-1566408649.119300">
        <div class="content">
          <div class="summary">
            <div class="user">k.marumaru524</div>
            <div class="date"><a class="date" href="#message-1566408649.119300">2019-08-22 02:30:49 +0900</a></div>
          </div>
          <div class="description">うおお、ありがとうございます:man-bowing:</div>
        </div>
      </div>
      <div class="event" id="message-1566409226.125900">
        <div class="content">
          <div class="summary">
            <div class="user">k.marumaru524</div>
            <div class="date"><a class="date" href="#message-1566409226.125900">2019-08-22 02:40:26 +0900</a></div>
          </div>
          <div class="description">質問ばかりで恐縮ですが、こんどはコード生成に関する雑な質問です。<br/><br/>ASTまで得られた状態で、他の言語などへのコード生成の処理を書きたいと思っています。<br/>関数型言語が構文解析が得意なのは耳にしていましたが、コード生成も得意なのは初めて知りました。<br/><br/>以下のような記事を見つけ、読んでみました。<br/><a href='https://keigoi.hatenadiary.org/entry/20111206/haskell_tagless_dsl'>https://keigoi.hatenadiary.org/entry/20111206/haskell_tagless_dsl</a><br/><a href='http://nebuta.hatenablog.com/entry/2013/08/01/143926'>http://nebuta.hatenablog.com/entry/2013/08/01/143926</a><br/>一度読んだだけでは正直、わからないところもわからないという感じですが、<br/>とりあえず以下のような話題を理解するように感じました<br/><br/>- 型クラスの自作<br/>- モナドの自作<br/>- モナド変換子の概念の理解と、扱い方<br/><br/>この記事を参考にして一つずつわからないところを潰していくつもりではありますが、もしこの「コード生成」の部分に関して入門者向けの良い記事や書籍、ライブラリや実装例、検索のための語彙などをご存知でしたら教えていただけると嬉しいです。<br/><br/>ターゲットなる言語は特に問うてませんが、実装中なのはアセンブリを吐くコンパイラです。<br/>現状、コード生成部分はすごい手続き的な書き方になってしまっています..<br/><a href='https://github.com/mrsekut/hcc/blob/master/app/Main.hs'>https://github.com/mrsekut/hcc/blob/master/app/Main.hs</a><br/><br/>よろしくお願いします。</div>
        </div>
      </div>
      <div class="event" id="message-1566425500.126500">
        <div class="content">
          <div class="summary">
            <div class="user">kakkun61</div>
            <div class="date"><a class="date" href="#message-1566425500.126500">2019-08-22 07:11:40 +0900</a></div>
          </div>
          <div class="description">モナド変換子ならこちらがオススメです<br/><a href='http://bicycle1885.hatenablog.com/entry/2012/12/08/165236'>http://bicycle1885.hatenablog.com/entry/2012/12/08/165236</a></div>
        </div>
      </div>
      <div class="event" id="message-1566425740.126800">
        <div class="content">
          <div class="summary">
            <div class="user">kakkun61</div>
            <div class="date"><a class="date" href="#message-1566425740.126800">2019-08-22 07:15:40 +0900</a></div>
          </div>
          <div class="description">モナド変換子を勉強すると、モナド変換子の型別名や newtype ラッパーを作るだけで事足りるので、オリジナルのモナドを作ることはほぼないと思います</div>
        </div>
      </div>
      <div class="event" id="message-1566435662.127000">
        <div class="content">
          <div class="summary">
            <div class="user">lotz</div>
            <div class="date"><a class="date" href="#message-1566435662.127000">2019-08-22 10:01:02 +0900</a></div>
          </div>
          <div class="description">コード生成、とは少し違うかもしれませんが、いちにぃさんのPDFを読んで生成する話の記事は読みやすくて面白いです~<br/><https://itchyny.hatenablog.com/entry/2015/09/16/100000></div>
        </div>
      </div>
      <div class="event" id="message-1566452346.127500">
        <div class="content">
          <div class="summary">
            <div class="user">matsubara0507</div>
            <div class="date"><a class="date" href="#message-1566452346.127500">2019-08-22 14:39:06 +0900</a></div>
          </div>
          <div class="description">ステップバイステップ何回も読んだなー笑</div>
        </div>
      </div>
      <div class="event" id="message-1566488800.128200">
        <div class="content">
          <div class="summary">
            <div class="user">k.marumaru524</div>
            <div class="date"><a class="date" href="#message-1566488800.128200">2019-08-23 00:46:40 +0900</a></div>
          </div>
          <div class="description">@kakkun61<br/>スッテプばいステップ読み進めています<br/>学びが深くてうずうずしています<br/>ありがとうございます!</div>
        </div>
      </div>
      <div class="event" id="message-1566492615.128700">
        <div class="content">
          <div class="summary">
            <div class="user">rio.nagae</div>
            <div class="date"><a class="date" href="#message-1566492615.128700">2019-08-23 01:50:15 +0900</a></div>
          </div>
          <div class="description">@rio.nagae has joined the channel</div>
        </div>
      </div>
      <div class="event" id="message-1566497424.128900">
        <div class="content">
          <div class="summary">
            <div class="user">k.marumaru524</div>
            <div class="date"><a class="date" href="#message-1566497424.128900">2019-08-23 03:10:24 +0900</a></div>
          </div>
          <div class="description">@lotz<br/><br/>まだちゃんと読んでいませんが、PDFを生成する記事もヤバそうです！(長い！そしてはてぶ数がすごい！)<br/>モナド変換子の記事をやり終えたら読んでみたいと思います<br/>ありがとうございます！</div>
        </div>
      </div>
      <div class="event" id="message-1566531019.129600">
        <div class="content">
          <div class="summary">
            <div class="user">kj1ktk</div>
            <div class="date"><a class="date" href="#message-1566531019.129600">2019-08-23 12:30:19 +0900</a></div>
          </div>
          <div class="description">@kj1ktk has joined the channel</div>
        </div>
      </div>
      <div class="event" id="message-1566543030.133200">
        <div class="content">
          <div class="summary">
            <div class="user">matsubara0507</div>
            <div class="date"><a class="date" href="#message-1566543030.133200">2019-08-23 15:50:30 +0900</a></div>
          </div>
          <div class="description">MacOS Sierra で stack lts-12.26 (GHC 8.4.4)だと平気なんだけど、lts-14.2 (GHC 8.6.5) だとリンカで死ぬ :cry:<br/><pre>
Linking .stack-work/dist/x86_64-osx/Cabal-2.4.0.1/build/site/site ...
Undefined symbols for architecture x86_64:
  "_utimensat", referenced from:       
      _cazW_info in libHSdirectory-1.3.3.0.a(Posix.o)
ld: symbol(s) not found for architecture x86_64
clang: error: linker command failed with exit code 1 (use -v to see invocation)
`gcc' failed in phase `Linker'. (Exit code: 1)
Completed 166 action(s).               

--  While building package matsubara0507-ghpages-0.3.1.0 using:
      $HOME/.stack/setup-exe-cache/x86_64-osx/Cabal-simple_mPHDZzAJ_2.4.0.1_ghc-8.6.5 --builddir=.stack-work/dist/x86_64-osx/Cabal-2.4.0.1 build exe:site --ghc-options " -fdiagnostics-color=always"
    Process exited with code: ExitFailure 1
</pre><br/>utimensat 使えないのに、utimensat 使えるフラグが立っちゃうせいだと思うんだけど、うーん、なぜだろ<br/>いろんなパターンで試した結果、GHC 8.6.4 からダメっぽい（lts-13.11 は行けて lts-13.19 はダメだった、Cabal も関係なかった）</div>
        </div>
      </div>
      <div class="event" id="message-1566543850.133300">
        <div class="content">
          <div class="summary">
            <div class="user">wado</div>
            <div class="date"><a class="date" href="#message-1566543850.133300">2019-08-23 16:04:10 +0900</a></div>
          </div>
          <div class="description">Undefined symbols for architecture x86_64: “_utimensat”, referenced from: _cazW_info in libHSdirectory-1.3.3.0.a(Posix.o)<br/><https://stackoverflow.com/questions/56029761/undefined-symbols-for-architecture-x86-64-utimensat-referenced-from-cazw><br/><br/>似たようなの見つけました。</div>
        </div>
      </div>
      <div class="event" id="message-1566544091.133600">
        <div class="content">
          <div class="summary">
            <div class="user">matsubara0507</div>
            <div class="date"><a class="date" href="#message-1566544091.133600">2019-08-23 16:08:11 +0900</a></div>
          </div>
          <div class="description">そうそう、それみた<br/>High Sierra 以上にすれば平気なんだろうけど</div>
        </div>
      </div>
      <div class="event" id="message-1566623466.133900">
        <div class="content">
          <div class="summary">
            <div class="user">knock.822</div>
            <div class="date"><a class="date" href="#message-1566623466.133900">2019-08-24 14:11:06 +0900</a></div>
          </div>
          <div class="description">@knock.822 has joined the channel</div>
        </div>
      </div>
      <div class="event" id="message-1566665189.134200">
        <div class="content">
          <div class="summary">
            <div class="user">realshinya1999</div>
            <div class="date"><a class="date" href="#message-1566665189.134200">2019-08-25 01:46:29 +0900</a></div>
          </div>
          <div class="description">@realshinya1999 has joined the channel</div>
        </div>
      </div>
      <div class="event" id="message-1566731735.134500">
        <div class="content">
          <div class="summary">
            <div class="user">yahiru1121</div>
            <div class="date"><a class="date" href="#message-1566731735.134500">2019-08-25 20:15:35 +0900</a></div>
          </div>
          <div class="description">@yahiru1121 has joined the channel</div>
        </div>
      </div>
      <div class="event" id="message-1566884214.135000">
        <div class="content">
          <div class="summary">
            <div class="user">sekikano721</div>
            <div class="date"><a class="date" href="#message-1566884214.135000">2019-08-27 14:36:54 +0900</a></div>
          </div>
          <div class="description">@sekikano721 has joined the channel</div>
        </div>
      </div>
      <div class="event" id="message-1566915490.135300">
        <div class="content">
          <div class="summary">
            <div class="user">nobuyuki.tomizawa</div>
            <div class="date"><a class="date" href="#message-1566915490.135300">2019-08-27 23:18:10 +0900</a></div>
          </div>
          <div class="description">@nobuyuki.tomizawa has joined the channel</div>
        </div>
      </div>
      <div class="event" id="message-1566948379.135600">
        <div class="content">
          <div class="summary">
            <div class="user">oza777you</div>
            <div class="date"><a class="date" href="#message-1566948379.135600">2019-08-28 08:26:19 +0900</a></div>
          </div>
          <div class="description">@oza777you has joined the channel</div>
        </div>
      </div>
      <div class="event" id="message-1567075207.005000">
        <div class="content">
          <div class="summary">
            <div class="user">igrep</div>
            <div class="date"><a class="date" href="#message-1567075207.005000">2019-08-29 19:40:07 +0900</a></div>
          </div>
          <div class="description">GHCのRTSについての質問です。 <a href='https://twitter.com/igrep/status/1167019215489863681'>https://twitter.com/igrep/status/1167019215489863681</a> に書いたとおりなのですが、<br/><a href='https://gitlab.haskell.org/ghc/ghc/wikis/commentary/rts/haskell-execution/pointer-tagging'>https://gitlab.haskell.org/ghc/ghc/wikis/commentary/rts/haskell-execution/pointer-tagging</a> で解説されている「tagged pointerによる最適化」というのは、 <a href='https://gitlab.haskell.org/ghc/ghc/blob/bd660edeb783a74e5ca3f1f82713b2aeedae19dc/includes/Cmm.h#L279-285'>https://gitlab.haskell.org/ghc/ghc/blob/bd660edeb783a74e5ca3f1f82713b2aeedae19dc/includes/Cmm.h#L279-285</a> で行われている、<br/>「タグを取得してみてタグが0じゃなかったらタグの値をそのまま返して、0だったら <code>%INFO_PTR</code> というマクロを呼ぶ」処理のこと、という理解で正しいでしょうか？</div>
        </div>
      </div>
      <div class="event" id="message-1567082253.005200">
        <div class="content">
          <div class="summary">
            <div class="user">takenobu.hs</div>
            <div class="date"><a class="date" href="#message-1567082253.005200">2019-08-29 21:37:33 +0900</a></div>
          </div>
          <div class="description">Pointer Tagging は、ヒープオブジェクトが評価済みか否かを、ポインタの下位ビットを使って表す実装方法になります。<br/><br/>タグが0でなければ「評価済み」であると判断して、そのヒープオブジェクトの評価を省略できます。<br/>そのヒープオブジェクトが値コンストラクタの場合は、タグのビットが値をそのものを表します。<br/>例えば、Maybe型の値であれば、タグが1なら「Nothing」で、タグが2なら「Just x」であることがわかります。<br/><br/>なお、タグが0の場合は「未評価」であるとして、そのヒープオブジェクトを評価（ENTER）します。<br/><br/>参考までに、pointer taggingの実装イメージはこんな感じです。<br/><a href='https://takenobu-hs.github.io/downloads/haskell_ghc_illustrated.pdf#page=37'>https://takenobu-hs.github.io/downloads/haskell_ghc_illustrated.pdf#page=37</a></div>
        </div>
      </div>
      <div class="event" id="message-1567084567.005400">
        <div class="content">
          <div class="summary">
            <div class="user">takenobu.hs</div>
            <div class="date"><a class="date" href="#message-1567084567.005400">2019-08-29 22:16:07 +0900</a></div>
          </div>
          <div class="description">なお、Pointer Tagging を使ったコードは、GHCのランタイムシステムだけでなく、GHCによるコンパイル結果のコード側にも表れます。例えば、 <code>case x of ... </code> の <code>x</code> が評価済みかを、pointer tagging で切り分けています。<br/><br/>少しコード例が古いですが、Pointer Tagging については、以下の箇所付近も参考になります。<br/><a href='https://gitlab.haskell.org/ghc/ghc/wikis/commentary/compiler/generated-code#example-7-case-expressions'>https://gitlab.haskell.org/ghc/ghc/wikis/commentary/compiler/generated-code#example-7-case-expressions</a></div>
        </div>
      </div>
      <div class="event" id="message-1567089206.006300">
        <div class="content">
          <div class="summary">
            <div class="user">k.marumaru524</div>
            <div class="date"><a class="date" href="#message-1567089206.006300">2019-08-29 23:33:26 +0900</a></div>
          </div>
          <div class="description">型の切り出しによる関数の書き換え方ついて質問させてください。<br/><br/>今まで以下のような型だったものを<br/><pre>
data Expr = Add Expr Expr
          | Sub Expr Expr
          | Nat Int
            deriving (Show, Eq)
</pre><br/><br/>以下のように切り出したいと考えています<br/><pre>
data BinOp = Add | Sub deriving (Show, Eq)
data Expr = BinOp Expr Expr
          | Nat Int
            deriving (Show, Eq)
</pre><br/><br/>それに伴い、今まで使っていた関数も少し手を加えなければいけないのですが、書き換え方がわかりません。<br/><pre>
-- 従来のもの
-- add ::= term | term ('+' add | "-" add)
add :: Parser Expr
add = term `chainl1` skipW1 addop

addop :: Parser (Expr -&gt; Expr -&gt; Expr)
addop = Add &lt;$ char '+' &lt;|&gt; Sub &lt;$ char '-'
</pre><br/><br/>欲しいaddopの型は`addop :: Parser (Expr -&gt; Expr -&gt; Expr)`ですが、このままだと`addop :: ParsecT String () Identity BinOp`になってしまいます。<br/><br/>今まで通り以下のように書けば、コンパイルは通りますが、欲しい物と結果が異なります。<br/><pre>
addop :: Parser (Expr -&gt; Expr -&gt; Expr)
addop = BinOp &lt;$ char '+' &lt;|&gt; BinOp &lt;$ char '-'
</pre><br/><br/>欲しい物の例→`Add (Nat 1) (Nat 2)<br/>得られる物の例→`BinOp (Nat 1) (Nat 2)<br/><br/>怒られている理由はわかりますが、直し方がわからないという状態です。<br/><br/>また、この問題を解決するために「Haskell 型 切り出し」などでいくつかググってみたのですが、良い成果が得られませんでした。<br/>もし今回の件のようなものに対して適当な用語などがあれば教えていただけると嬉しいです。<br/><br/>よろしくお願いします。<br/><br/><br/>変更前のコードの全体はいかにあります<br/><a href='https://github.com/mrsekut/hcc/blob/master/src/Parser.hs'>https://github.com/mrsekut/hcc/blob/master/src/Parser.hs</a></div>
        </div>
      </div>
      <div class="event" id="message-1567089924.006800">
        <div class="content">
          <div class="summary">
            <div class="user">k.marumaru524</div>
            <div class="date"><a class="date" href="#message-1567089924.006800">2019-08-29 23:45:24 +0900</a></div>
          </div>
          <div class="description">この型の切り出し方で、記述する関数の数が減ったりするわけではないので、このように切り出す事自体が微妙なのかなとも思い始めました。<br/>単純にExprの定義が多少見やすくなるかなというのと、こういう切り出し方をしている例をよく見るなというのがモチベーションですが、それがそもそも正しいのかもわかりません</div>
        </div>
      </div>
      <div class="event" id="message-1567090511.007100">
        <div class="content">
          <div class="summary">
            <div class="user">matsubara0507</div>
            <div class="date"><a class="date" href="#message-1567090511.007100">2019-08-29 23:55:11 +0900</a></div>
          </div>
          <div class="description">まず、切り出したあとの Expr の定義間違ってない？<br/><code>Expr = B BinOp Expr Expr | Nat Int</code> じゃないとじゃない？<br/>ただの typo ならいいんだけど</div>
        </div>
      </div>
      <div class="event" id="message-1567091201.007300">
        <div class="content">
          <div class="summary">
            <div class="user">k.marumaru524</div>
            <div class="date"><a class="date" href="#message-1567091201.007300">2019-08-30 00:06:41 +0900</a></div>
          </div>
          <div class="description">typoのつもりではありませんでした<br/>なるほど！、ただ切り出してエイリアスのように使うものではなく、ネストが一階層深くなるのですね<br/>そうすることでパターンマッチなどもできるのですね.<br/>型コンストラクタや値コンストラクタなどに対する理解が甘いのかもしれません。<br/>ご教示頂いたコードなら動かすことができました。<br/>ありがとうございます！</div>
        </div>
      </div>
      <div class="event" id="message-1567121011.008000">
        <div class="content">
          <div class="summary">
            <div class="user">igrep</div>
            <div class="date"><a class="date" href="#message-1567121011.008000">2019-08-30 08:23:31 +0900</a></div>
          </div>
          <div class="description">tagで切り分けている、というのは <code>if (R1 &amp; 3 != 0) goto ccA;</code> の行のことですよね？</div>
        </div>
      </div>
      <div class="event" id="message-1567170273.008200">
        <div class="content">
          <div class="summary">
            <div class="user">takenobu.hs</div>
            <div class="date"><a class="date" href="#message-1567170273.008200">2019-08-30 22:04:33 +0900</a></div>
          </div>
          <div class="description">はい、 <code>if (R1 &amp; 3 != 0) goto ccA;</code> が１つめの切り分けです。<br/>ここは、 <code>x</code> が「評価済みか否か」を切り分けています。<br/>（未評価の場合のみ、 <code>x</code> を評価（xのコードへjump）します。）<br/><br/>続いて、 <code>if (_ccu::I32 &gt;= 2) goto ccv;</code> が２つめの切り分けです。<br/>ここは、コンストラクタの値を切り分けています。（caseの各節への分岐に相当します。）<br/>tagの部分が「1」なら <code>Nothing</code> で、「2」なら <code>Just</code> を表します。<br/>ここでは、 <code>&gt;= 2</code> によって、 <code>Just</code> かを切り分けています。<br/>つまり、pointer の tag の部分をみると、「評価済みか否か」に加えて<br/>「そのコンストラクタの値が何か」までをも判別できます。<br/><br/>つまり、 <code>x</code> の実体にメモリアクセスすることなく、 <code>x</code> が評価済みかと、<br/><code>x</code> の値が何かがわかるのが、pointer taggingの良いところです。</div>
        </div>
      </div>
      <div class="event" id="message-1567208371.008500">
        <div class="content">
          <div class="summary">
            <div class="user">cj.bc-sd</div>
            <div class="date"><a class="date" href="#message-1567208371.008500">2019-08-31 08:39:31 +0900</a></div>
          </div>
          <div class="description">見てみます！ありがとうございます</div>
        </div>
      </div>
      <div class="event" id="message-1567304642.008800">
        <div class="content">
          <div class="summary">
            <div class="user">9647142</div>
            <div class="date"><a class="date" href="#message-1567304642.008800">2019-09-01 11:24:02 +0900</a></div>
          </div>
          <div class="description">@9647142 has joined the channel</div>
        </div>
      </div>
      <div class="event" id="message-1567523189.015500">
        <div class="content">
          <div class="summary">
            <div class="user">igrep</div>
            <div class="date"><a class="date" href="#message-1567523189.015500">2019-09-04 00:06:29 +0900</a></div>
          </div>
          <div class="description">ある式がWHNFまで評価されたときに占めるメモリー消費量の比較を、criterion <a href='http://hackage.haskell.org/package/criterion'>http://hackage.haskell.org/package/criterion</a> や<br/>gauge <a href='http://hackage.haskell.org/package/gauge'>http://hackage.haskell.org/package/gauge</a><br/>のような要領で行えたら便利かな、と思うのですが、<br/>(1) そういう目的のパッケージはあるでしょうか？あるいは、素直にGHCのプロファイリング機能を使った方が良いのでしょうか？<br/>(2) 仮にそうした処理を自分で書くとしたら、<br/>System.Mem <a href='http://hackage.haskell.org/package/base-4.12.0.0/docs/System-Mem.html'>http://hackage.haskell.org/package/base-4.12.0.0/docs/System-Mem.html</a> の<br/><code>setAllocationCounter</code> や <code>getAllocationCounter</code> を使うのが正解なんでしょうか。<br/>というのも、今回の私のユースケースにおいては、基本的に同じサイズのデータを何度も割り当てる式を比較するため、簡易的な比較としてはアリなんじゃないかと思いまして。</div>
        </div>
      </div>
      <div class="event" id="message-1567524131.015700">
        <div class="content">
          <div class="summary">
            <div class="user">mizunashi-mana</div>
            <div class="date"><a class="date" href="#message-1567524131.015700">2019-09-04 00:22:11 +0900</a></div>
          </div>
          <div class="description">Heap allocation なら weigh <a href='http://hackage.haskell.org/package/weigh'>http://hackage.haskell.org/package/weigh</a> というのがありますね。ただ strict のあれのやつなら測るべきはスタックのサイズなので、それはちょっと分からないですね。 stack leak は rts option でスタックサイズを小さくしてやるとお手軽に確認できます</div>
        </div>
      </div>
      <div class="event" id="message-1567550715.017400">
        <div class="content">
          <div class="summary">
            <div class="user">maoe</div>
            <div class="date"><a class="date" href="#message-1567550715.017400">2019-09-04 07:45:15 +0900</a></div>
          </div>
          <div class="description">criterionでも—regress=allocated:itersみたいなオプションでできるはずです</div>
        </div>
      </div>
      <div class="event" id="message-1567550760.018300">
        <div class="content">
          <div class="summary">
            <div class="user">maoe</div>
            <div class="date"><a class="date" href="#message-1567550760.018300">2019-09-04 07:46:00 +0900</a></div>
          </div>
          <div class="description"><a href='http://www.serpentine.com/criterion/tutorial.html'>http://www.serpentine.com/criterion/tutorial.html</a> allocatedで検索すると書いてあります</div>
        </div>
      </div>
      <div class="event" id="message-1567552875.018800">
        <div class="content">
          <div class="summary">
            <div class="user">igrep</div>
            <div class="date"><a class="date" href="#message-1567552875.018800">2019-09-04 08:21:15 +0900</a></div>
          </div>
          <div class="description">ありがとうございます！<br/>おっしゃる通りStrict拡張の件 <a href='https://github.com/haskell-jp/blog/issues/167'>https://github.com/haskell-jp/blog/issues/167</a> なので、RTSオプションでやる方向で検討します。</div>
        </div>
      </div>
      <div class="event" id="message-1567585876.022500">
        <div class="content">
          <div class="summary">
            <div class="user">a_kirisaki</div>
            <div class="date"><a class="date" href="#message-1567585876.022500">2019-09-04 17:31:16 +0900</a></div>
          </div>
          <div class="description">プログラミング言語を作ってそれをパースするためにAlex+Happyを使ってるのですが、Alexのwrapperを使うと例外を <code>String</code> でしか返してくれない（きちんとしたデータ型で返ってきてほしい）のでどうしたものかなと思ってます。解決策としてLow-levelなAPIを使ってrunAlexを自前で書くのと他のパーサコンビネータ使ってしまうのとがあると思うんですが、どっちのほうが辛くなさそうでしょうか</div>
        </div>
      </div>
      <div class="event" id="message-1567587042.023800">
        <div class="content">
          <div class="summary">
            <div class="user">9647142</div>
            <div class="date"><a class="date" href="#message-1567587042.023800">2019-09-04 17:50:42 +0900</a></div>
          </div>
          <div class="description">alex使ったことないのでよくわかりませんが、パーサコンビネータ(megaparsecとか)は別に辛くないと思いますよ(これは罠で、今絶賛megaparsecで消耗中)</div>
        </div>
      </div>
      <div class="event" id="message-1567587305.025300">
        <div class="content">
          <div class="summary">
            <div class="user">9647142</div>
            <div class="date"><a class="date" href="#message-1567587305.025300">2019-09-04 17:55:05 +0900</a></div>
          </div>
          <div class="description">ところで言語処理系を作っているのならプログラミング言語処理系slackなんかはどうです?<br/><a href='http://prog-lang-sys-ja.slack.com/'>http://prog-lang-sys-ja.slack.com/</a></div>
        </div>
      </div>
      <div class="event" id="message-1567587446.026100">
        <div class="content">
          <div class="summary">
            <div class="user">a_kirisaki</div>
            <div class="date"><a class="date" href="#message-1567587446.026100">2019-09-04 17:57:26 +0900</a></div>
          </div>
          <div class="description">ありがとうございます。今回の質問とは関係ありませんが興味あるので覗いてみます</div>
        </div>
      </div>
      <div class="event" id="message-1567591165.026500">
        <div class="content">
          <div class="summary">
            <div class="user">igrep</div>
            <div class="date"><a class="date" href="#message-1567591165.026500">2019-09-04 18:59:25 +0900</a></div>
          </div>
          <div class="description">AlexもHappyも全然使ったことないので逆に気になるんですが、なんでAlex+Happyでやろうとしてるんですか？</div>
        </div>
      </div>
    </div>
    <div class="ui pagination menu">
      <a href="../../html/C5666B6BB/67.html" class="item">Previous</a>
      <a href="../../" class="item">Top</a>
      <a href="../../html/C5666B6BB/69.html" class="item">Next</a>
    </div>
  </div>
</body>
</html>
