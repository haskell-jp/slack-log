<!DOCTYPE html><html><head><meta charset="utf-8"><title>haskell-jp / questions #93</title><link rel="stylesheet" href="../../main.css" type="text/css" media="screen"></head><body><div class="ui container"><h1>haskell-jp / questions #93</h1><div class="pager ui pagination menu"><a href="../../html/C5666B6BB/92.html" class="pager__previous item">Previous</a><a href="../../" class="pager__top item">Top</a></div><div class="message_list ui feed"><div class="message event" id="message-1604410736.138100"><div class="content"><div class="summary"><div class="message__header user">ttaakkee</div><div class="message__timestamp date"><a class="date" href="#message-1604410736.138100">2020-11-03&nbsp;22:38:56 +0900</a></div></div><div class="message__body description">なるほど〜<br/>整理して考えるとたしかに！<br/><code>name</code> は <code>env</code> に依存してないってだけなのに、それだけで、`AnyBot`の定義のせいで異質なメソッドになっちゃってる感じですね༼;´༎ຶ ༎ຶ༽<br/><br/>(ちなみにpackってなんですか？:exploding_head:)</div></div></div><div class="message event" id="message-1604411412.143900"><div class="content"><div class="summary"><div class="message__header user">ttaakkee</div><div class="message__timestamp date"><a class="date" href="#message-1604411412.143900">2020-11-03&nbsp;22:50:12 +0900</a></div></div><div class="message__body description"><code>env</code>が多相的なのは Has Type Class Pattern とかいうしきたりを真似してみたかんじです:sob:<br/>メソッドの呼び出し元によって具体的な`env`の型が変わり得るので多相的にしたい感じです:sob:</div></div></div><div class="message event" id="message-1604414976.147500"><div class="content"><div class="summary"><div class="message__header user">ttaakkee</div><div class="message__timestamp date"><a class="date" href="#message-1604414976.147500">2020-11-03&nbsp;23:49:36 +0900</a></div></div><div class="message__body description"><code>QuantifiedConstraints</code>なんて拡張があるんですね！<br/>なんかへんなとこに`forall`ついてる:exploding_head:<br/>調べながら読んでたんですけど今のところわけわかめです༼;´༎ຶ ༎ຶ༽×999</div></div></div><div class="message event" id="message-1604569571.148000"><div class="content"><div class="summary"><div class="message__header user">ttaakkee</div><div class="message__timestamp date"><a class="date" href="#message-1604569571.148000">2020-11-05&nbsp;18:46:11 +0900</a></div></div><div class="message__body description">何がどうなってるのかさっぱりわからないです:shocked_face_with_exploding_head: :joy:<br/><pre>AnyBot :: forall b. (Bot b, forall env. Dep AnyBot env =&gt; BotDep b env) =&gt; b -&gt; AnyBot</pre><br/>これって一体何を意味してるんですか?:exploding_head::x::one::zero::zero::zero:</div></div></div><div class="message event" id="message-1604585342.148200"><div class="content"><div class="summary"><div class="message__header user">mizunashi-mana</div><div class="message__timestamp date"><a class="date" href="#message-1604585342.148200">2020-11-05&nbsp;23:09:02 +0900</a></div></div><div class="message__body description">&gt; (ちなみにpackってなんですか？:exploding_head:)<br/>AnyBot のような、ある型の値を existential type の値に変換する操作のことですね。AnyBot の適用と読み替えてもらって構わないです<br/><br/>&gt; これって一体何を意味してるんですか?<br/>GADTSyntax 使わず existential type で書き直すなら、<br/>```data AnyBot = forall b. (Bot b, forall env. Dep AnyBot env =&gt; BotDep b env) =&gt; AnyBot b```<br/>と同じですね。`(Bot b, forall env. Dep AnyBot env =&gt; BotDep b env)` の部分は、<br/>* `Bot b` の制約が成り立つ<br/>* 任意の `env` 型について、`Dep AnyBot env` 制約が成り立つならば `BotDep b env` 制約が成り立つ<br/>の両方が成り立つみたいな意味ですね。`forall env. Dep AnyBot env =&gt; BotDep b env` の部分が `QuantifiedConstraints` 拡張により表現可能になる制約です</div></div></div><div class="message event" id="message-1604603465.149000"><div class="content"><div class="summary"><div class="message__header user">ttaakkee</div><div class="message__timestamp date"><a class="date" href="#message-1604603465.149000">2020-11-06&nbsp;04:11:05 +0900</a></div></div><div class="message__body description">ウ～ン(+_+)<br/><br/>1. <code>AnyBot</code> の型パラメタに <code>env</code>  をもたせると、`env` を必要としない <code>name</code> メソッドの呼び出しがえらいことになるから、`AnyBot` に <code>env</code>  をもたせない。<br/>2. すると <code>reply</code> メソッドの呼び出しに必要な <code>Dep b env</code> が足りなくなっちゃうから、`AnyBot`  にパターンマッチしたときに使える制約に <code>forall env. Dep b env</code>  的なものを入れたい。<br/>3. <code>QuantifiedConstraints</code>  拡張では <code>Dep b env</code>  みたいな型族をかけないから、仕方なく <code>BotDep</code>  型クラスを追加して、`instance Dep AnyBot env =&gt; BotDep AnyBot env` とかやって <code>BotDep</code>  から <code>Dep</code>  が得られるようにしてる。<br/>って感じのアイディアで大体あってますか?<br/>むずすぎてむりちゃづけです༼;´༎ຶ ༎ຶ༽</div></div></div><div class="message event" id="message-1604618745.150100"><div class="content"><div class="summary"><div class="message__header user">mizunashi-mana</div><div class="message__timestamp date"><a class="date" href="#message-1604618745.150100">2020-11-06&nbsp;08:25:45 +0900</a></div></div><div class="message__body description">`forall env. Dep AnyBot env =&gt; BotDep b env` というのは、気持ち的には `forall env. Dep AnyBot env =&gt; Dep b env` と同じですね。これは、<br/><br/>`Dep AnyBot env` 制約が成り立つ場合に、`Dep b env` 制約が成り立つ<br/><br/>つまり、`AnyBot` コンストラクタで pack できる型は、<br/><br/>* `Bot` 制約を満たし<br/>* `AnyBot` の `Dep` 制約 (今回は `HasLogFunc`) だけから、`Dep` に必要な制約を導ける (今回は例えば `Dep MarkovChain env` は `HasLogFunc env` と同じなので、`Dep MarkovChain env` は `HasLogFunc env`、つまり `Dep AnyBot env` の制約から導けます。もし `Dep MarkovChain env` が `(HasLogFunc env, HasWriteRef Task env)` みたいな制約を必要としていた場合、これは `HasLogFunc env` 制約からは導けないので AnyBot コンストラクタでの pack は失敗します)<br/><br/>みたいな条件のものだけということになります。この条件を守っているなら、各ボットの `reply :: Dep b env =&gt; ...` は `reply :: Dep AnyBot env =&gt; ...` と書いても実装ができるはずなので、`AnyBot` の `Bot` インスタンスが実装できます。そして、上の `AnyBot` コンストラクタで pack される時の条件は `Dep` が成り立つ必要は特に要求していなくて、*もし `Dep AnyBot env` が成り立つならば* `Dep b env` が成り立つことを要求しているだけなので、`Dep` は成り立たなくても pack はでき、`name` も特に `Dep` 制約を必要としないので呼び出せるということになりますね</div></div></div><div class="message event" id="message-1604619115.150400"><div class="content"><div class="summary"><div class="message__header user">mizunashi-mana</div><div class="message__timestamp date"><a class="date" href="#message-1604619115.150400">2020-11-06&nbsp;08:31:55 +0900</a></div></div><div class="message__body description">ああ、それと <code>BotDep</code> 型クラスについてですが、これは本質的なものではなくて <code>QuantifiedConstraints</code> の制約でこういうのを作らないといけないというだけですね。<https://ghc.gitlab.haskell.org/ghc/doc/users_guide/exts/quantified_constraints.html#termination> に制約の内容がありますが、`QuantifiedConstraints` の実装上の制約で <code>forall env. Dep AnyBot env =&gt; ...</code> の <code>...</code> の部分には type family は書けません。なので、`forall env. Dep AnyBot env =&gt; Dep b env` とは書けないので、代わりに <code>Dep b env</code> に相当する型クラス <code>BotDep b env</code> を作ってそれを指定しています。</div></div></div><div class="message event" id="message-1604696865.151400"><div class="content"><div class="summary"><div class="message__header user">ttaakkee</div><div class="message__timestamp date"><a class="date" href="#message-1604696865.151400">2020-11-07&nbsp;06:07:45 +0900</a></div></div><div class="message__body description">わあ!そういうことか!完全に理解しました!:serval:<br/><code>forall env. Dep AnyBot env =&gt; BotDep b env</code> ってのは、左辺の <code>Dep AnyBot env</code> の制約が右辺の <code>BotDep b env</code> より厳しい、即ち、`type Dep AnyBot env = ...` で羅列されてる制約の中に、packされようとしている <code>Bot</code> インスタンスの <code>Dep</code>  の制約が含まれてることを要求してるんですね!<br/><br/><code>BotDep</code> 型クラスのあたりもいまいちどういう発想て゛そんなこと考えついたのかわかりません:sob:<br/><code>go :: Bot b =&gt; BotDep b env =&gt; b -&gt; String -&gt; RIO env (Maybe String)</code> の部分の <code>=&gt;</code> が重なっているのはなぜなのでしょうか?</div></div></div><div class="message event" id="message-1604720450.152200"><div class="content"><div class="summary"><div class="message__header user">taxtu06</div><div class="message__timestamp date"><a class="date" href="#message-1604720450.152200">2020-11-07&nbsp;12:40:50 +0900</a></div></div><div class="message__body description">@taxtu06 has joined the channel</div></div></div><div class="message event" id="message-1604722111.152300"><div class="content"><div class="summary"><div class="message__header user">mizunashi-mana</div><div class="message__timestamp date"><a class="date" href="#message-1604722111.152300">2020-11-07&nbsp;13:08:31 +0900</a></div></div><div class="message__body description"><blockquote>go :: Bot b =&gt; BotDep b env =&gt; b -&gt; String -&gt; RIO env (Maybe String) の部分の =&gt; が重なっているのはなぜなのでしょう</blockquote>ああ、すいません。癖で書いちゃいましたが、`Bot b =&gt; BotDep b env =&gt;` は <code>(Bot b, BotDep b env) =&gt;</code> と同じです</div></div></div><div class="message event" id="message-1604731271.152600"><div class="content"><div class="summary"><div class="message__header user">takenari.shinohara</div><div class="message__timestamp date"><a class="date" href="#message-1604731271.152600">2020-11-07&nbsp;15:41:11 +0900</a></div></div><div class="message__body description">@takenari.shinohara has joined the channel</div></div></div><div class="message event" id="message-1604911576.153200"><div class="content"><div class="summary"><div class="message__header user">ttaakkee</div><div class="message__timestamp date"><a class="date" href="#message-1604911576.153200">2020-11-09&nbsp;17:46:16 +0900</a></div></div><div class="message__body description">ありがとうございます:arigatougozaimasu:<br/>そうだったんですね!文脈のところもカリー化みたいな感じなことできるんですね!<br/><br/>後もう一つ、`UndecidableSuperClasses` スーパークラスとして型族指定しているのも初めて見ました・・・<br/>調べているんですけどこれもどう考えればいいのかイマイチまだつかめてないです:sob:</div></div></div><div class="message event" id="message-1604977000.153500"><div class="content"><div class="summary"><div class="message__header user">mayoimaimai9</div><div class="message__timestamp date"><a class="date" href="#message-1604977000.153500">2020-11-10&nbsp;11:56:40 +0900</a></div></div><div class="message__body description">@mayoimaimai9 has joined the channel</div></div></div><div class="message event" id="message-1605066217.153700"><div class="content"><div class="summary"><div class="message__header user">aka2tom8bo_slack</div><div class="message__timestamp date"><a class="date" href="#message-1605066217.153700">2020-11-11&nbsp;12:43:37 +0900</a></div></div><div class="message__body description">@aka2tom8bo_slack has joined the channel</div></div></div><div class="message event" id="message-1605092063.155100"><div class="content"><div class="summary"><div class="message__header user">ttaakkee</div><div class="message__timestamp date"><a class="date" href="#message-1605092063.155100">2020-11-11&nbsp;19:54:23 +0900</a></div></div><div class="message__body description">わあーごめんなさい:woman-bowing:<br/>一呼吸おいて冷静に考えてみたら全部理解できました༼;´༎ຶ ༎ຶ༽<br/>すごい勉強になりましたありがとうございます！！！🥳:star-struck:</div></div></div><div class="message event" id="message-1605334722.162000"><div class="content"><div class="summary"><div class="message__header user">sevensins0410s</div><div class="message__timestamp date"><a class="date" href="#message-1605334722.162000">2020-11-14&nbsp;15:18:42 +0900</a></div></div><div class="message__body description">@sevensins0410s has joined the channel</div></div></div><div class="message event" id="message-1605575950.163500"><div class="content"><div class="summary"><div class="message__header user">kazu</div><div class="message__timestamp date"><a class="date" href="#message-1605575950.163500">2020-11-17&nbsp;10:19:10 +0900</a></div></div><div class="message__body description">GHC 9.0.0-alpha1 は bytestring-0.10 を使っているようですが、最新の 0.11 が含まれるのは alpha2 からでしょうか？</div></div></div><div class="message event" id="message-1605683225.163600"><div class="content"><div class="summary"><div class="message__header user">ttaakkee</div><div class="message__timestamp date"><a class="date" href="#message-1605683225.163600">2020-11-18&nbsp;16:07:05 +0900</a></div></div><div class="message__body description">新しくBotを追加するたびに`allBots`だけでなく`AnyBot`のインスタンス定義まで書き換えなきゃいけないのが少しイヤだったので、自分なりに作ってみたら難しくなっちゃいました:sob:<br/><br/>もっと上手に書くやり方ありませんか?<br/>あと変数名や関数名などももっと良いのありますか?:exploding_head:</div></div></div><div class="message event" id="message-1605700699.164100"><div class="content"><div class="summary"><div class="message__header user">yuki2501</div><div class="message__timestamp date"><a class="date" href="#message-1605700699.164100">2020-11-18&nbsp;20:58:19 +0900</a></div></div><div class="message__body description">@yuki2501 has joined the channel</div></div></div><div class="message event" id="message-1605703967.164200"><div class="content"><div class="summary"><div class="message__header user">mizunashi-mana</div><div class="message__timestamp date"><a class="date" href="#message-1605703967.164200">2020-11-18&nbsp;21:52:47 +0900</a></div></div><div class="message__body description"></div></div></div><div class="message event" id="message-1605704015.164600"><div class="content"><div class="summary"><div class="message__header user">mizunashi-mana</div><div class="message__timestamp date"><a class="date" href="#message-1605704015.164600">2020-11-18&nbsp;21:53:35 +0900</a></div></div><div class="message__body description">なるほど， <code>AnyBot</code> を constraint 持てるようにしておくと，後から変えられて確かに便利ですね．HList のところは，単に一々 <code>SomeBot</code> を <code>allBots</code> の全てのボットで書くのが面倒という理由で使ってるなら，ビルダをそもそも定義すればいいだけだと思いますね．その例が上に post したやつです</div></div></div></div><div class="pager ui pagination menu"><a href="../../html/C5666B6BB/92.html" class="pager__previous item">Previous</a><a href="../../" class="pager__top item">Top</a></div></div></body></html>