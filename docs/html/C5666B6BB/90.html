<!DOCTYPE html><html><head><meta charset="utf-8"><title>haskell-jp / questions #90</title><link rel="stylesheet" href="../../main.css" type="text/css" media="screen"></head><body><div class="ui container"><h1>haskell-jp / questions #90</h1><div class="pager ui pagination menu"><a href="../../html/C5666B6BB/89.html" class="pager__previous item">Previous</a><a href="../../" class="pager__top item">Top</a></div><div class="message_list ui feed"><div class="message event" id="message-1600500174.000400"><div class="content"><div class="summary"><div class="message__header user">izawaskell693</div><div class="message__timestamp date"><a class="date" href="#message-1600500174.000400">2020-09-19&nbsp;16:22:54 +0900</a></div></div><div class="message__body description">@izawaskell693 has joined the channel</div></div></div><div class="message event" id="message-1600571689.000600"><div class="content"><div class="summary"><div class="message__header user">shun.otani_haskell-jp</div><div class="message__timestamp date"><a class="date" href="#message-1600571689.000600">2020-09-20&nbsp;12:14:49 +0900</a></div></div><div class="message__body description">@shun.otani_haskell-jp has joined the channel</div></div></div><div class="message event" id="message-1600584709.000800"><div class="content"><div class="summary"><div class="message__header user">igrep</div><div class="message__timestamp date"><a class="date" href="#message-1600584709.000800">2020-09-20&nbsp;15:51:49 +0900</a></div></div><div class="message__body description">こんな感じの型って既存のパッケージにありますか？<br/><pre>data EList e a = End e | ECons a (EList e a)</pre><br/>リストの末尾に情報を1個付け加えたいのです。</div></div></div><div class="message event" id="message-1600584884.000900"><div class="content"><div class="summary"><div class="message__header user">igrep</div><div class="message__timestamp date"><a class="date" href="#message-1600584884.000900">2020-09-20&nbsp;15:54:44 +0900</a></div></div><div class="message__body description">補足すると、こういう形のリストに対して、主に結合演算をしたいです。</div></div></div><div class="message event" id="message-1600585010.001100"><div class="content"><div class="summary"><div class="message__header user">kakkun61</div><div class="message__timestamp date"><a class="date" href="#message-1600585010.001100">2020-09-20&nbsp;15:56:50 +0900</a></div></div><div class="message__body description"><code>(List a, e)</code> の同型ということですか？</div></div></div><div class="message event" id="message-1600585095.001300"><div class="content"><div class="summary"><div class="message__header user">igrep</div><div class="message__timestamp date"><a class="date" href="#message-1600585095.001300">2020-09-20&nbsp;15:58:15 +0900</a></div></div><div class="message__body description">だと思いますし、それでいいかな...</div></div></div><div class="message event" id="message-1600585857.001500"><div class="content"><div class="summary"><div class="message__header user">igrep</div><div class="message__timestamp date"><a class="date" href="#message-1600585857.001500">2020-09-20&nbsp;16:10:57 +0900</a></div></div><div class="message__body description">と、思ったけど今回の問題に割と固有（でも一般化はできそう？）な気がしたので独自に作っちゃいます。詳しい事情はそのパッケージリリースしたとき書きます。</div></div></div><div class="message event" id="message-1600587771.003600"><div class="content"><div class="summary"><div class="message__header user">slackbot</div><div class="message__timestamp date"><a class="date" href="#message-1600587771.003600">2020-09-20&nbsp;16:42:51 +0900</a></div></div><div class="message__body description">This message was deleted.</div></div></div><div class="message event" id="message-1600588064.003700"><div class="content"><div class="summary"><div class="message__header user">igrep</div><div class="message__timestamp date"><a class="date" href="#message-1600588064.003700">2020-09-20&nbsp;16:47:44 +0900</a></div></div><div class="message__body description">もくもく会中の独り言であれば <a href='#CUPBC8WCE'>mokumoku-online</a> にお願いします！ :pray:</div></div></div><div class="message event" id="message-1600588499.003900"><div class="content"><div class="summary"><div class="message__header user">kakkun61</div><div class="message__timestamp date"><a class="date" href="#message-1600588499.003900">2020-09-20&nbsp;16:54:59 +0900</a></div></div><div class="message__body description">まっちがえた</div></div></div><div class="message event" id="message-1600593599.004500"><div class="content"><div class="summary"><div class="message__header user">hello</div><div class="message__timestamp date"><a class="date" href="#message-1600593599.004500">2020-09-20&nbsp;18:19:59 +0900</a></div></div><div class="message__body description">@hello has joined the channel</div></div></div><div class="message event" id="message-1600609671.004600"><div class="content"><div class="summary"><div class="message__header user">notogawa</div><div class="message__timestamp date"><a class="date" href="#message-1600609671.004600">2020-09-20&nbsp;22:47:51 +0900</a></div></div><div class="message__body description"><code>Data.List.NonEmpty</code> では</div></div></div><div class="message event" id="message-1600609701.004800"><div class="content"><div class="summary"><div class="message__header user">notogawa</div><div class="message__timestamp date"><a class="date" href="#message-1600609701.004800">2020-09-20&nbsp;22:48:21 +0900</a></div></div><div class="message__body description">あ，違う型なのか</div></div></div><div class="message event" id="message-1600629095.005100"><div class="content"><div class="summary"><div class="message__header user">kunihiro</div><div class="message__timestamp date"><a class="date" href="#message-1600629095.005100">2020-09-21&nbsp;04:11:35 +0900</a></div></div><div class="message__body description">@kunihiro has joined the channel</div></div></div><div class="message event" id="message-1600736594.005300"><div class="content"><div class="summary"><div class="message__header user">ykominami</div><div class="message__timestamp date"><a class="date" href="#message-1600736594.005300">2020-09-22&nbsp;10:03:14 +0900</a></div></div><div class="message__body description">@ykominami has joined the channel</div></div></div><div class="message event" id="message-1600753892.005400"><div class="content"><div class="summary"><div class="message__header user">dfordivam</div><div class="message__timestamp date"><a class="date" href="#message-1600753892.005400">2020-09-22&nbsp;14:51:32 +0900</a></div></div><div class="message__body description">どのようなプログラムですか？Jsaddleを使っていますか？確かにghcjs の開発は停止しているそうです。GHC8.8, や8.10 はないですね。</div></div></div><div class="message event" id="message-1600758537.005700"><div class="content"><div class="summary"><div class="message__header user">b1714935</div><div class="message__timestamp date"><a class="date" href="#message-1600758537.005700">2020-09-22&nbsp;16:08:57 +0900</a></div></div><div class="message__body description">@b1714935 has joined the channel</div></div></div><div class="message event" id="message-1600821584.000400"><div class="content"><div class="summary"><div class="message__header user">kazu</div><div class="message__timestamp date"><a class="date" href="#message-1600821584.000400">2020-09-23&nbsp;09:39:44 +0900</a></div></div><div class="message__body description">ByteString 0.11 では、内部のコンストラクタが PS から BS になり、offset フィールドがなくなります。これに伴い、foreign pointer は、必ずそのByteStringのバッファの先頭を指します。drop なんかで、バッファを共有する場合、foreign pointer がいろんなところを指すようになりますが、この方法でバッファはうまく GC できるんでしょうか？</div></div></div><div class="message event" id="message-1600826197.000500"><div class="content"><div class="summary"><div class="message__header user">fumieval</div><div class="message__timestamp date"><a class="date" href="#message-1600826197.000500">2020-09-23&nbsp;10:56:37 +0900</a></div></div><div class="message__body description"><pre>data ForeignPtr a = ForeignPtr Addr# ForeignPtrContents</pre><br/>の定義を見れば分かる通り、ForeignPtrには既にアドレスと実体を表す値(MutableByteArray#など)の二つが入っています。故にplusForeignPtrなどは安全に定義できます</div></div></div><div class="message event" id="message-1600829656.000700"><div class="content"><div class="summary"><div class="message__header user">kazu</div><div class="message__timestamp date"><a class="date" href="#message-1600829656.000700">2020-09-23&nbsp;11:54:16 +0900</a></div></div><div class="message__body description">なるほど！ ありがとうございました。</div></div></div><div class="message event" id="message-1600845249.001000"><div class="content"><div class="summary"><div class="message__header user">ryuji.sg100</div><div class="message__timestamp date"><a class="date" href="#message-1600845249.001000">2020-09-23&nbsp;16:14:09 +0900</a></div></div><div class="message__body description">@ryuji.sg100 has joined the channel</div></div></div><div class="message event" id="message-1600944992.004400"><div class="content"><div class="summary"><div class="message__header user">gettaplacetogo</div><div class="message__timestamp date"><a class="date" href="#message-1600944992.004400">2020-09-24&nbsp;19:56:32 +0900</a></div></div><div class="message__body description">これに関連してずっと気になっていたのですが，<br/><a href='https://haskell-jp.slack.com/archives/C5666B6BB/p1600826197000500?thread_ts=1600821584.000400&amp;cid=C5666B6BB'>https://haskell-jp.slack.com/archives/C5666B6BB/p1600826197000500?thread_ts=1600821584.000400&amp;cid=C5666B6BB</a><br/><pre>data Finalizers
  = NoFinalizers
  | CFinalizers (Weak# ())
  | HaskellFinalizers [IO ()]

data ForeignPtrContents
  = PlainForeignPtr !(IORef Finalizers)
  | MallocPtr      (MutableByteArray# RealWorld) !(IORef Finalizers)
  | PlainPtr       (MutableByteArray# RealWorld)

data ForeignPtr a = ForeignPtr Addr# ForeignPtrContents</pre><br/>この定義で，`ForeignPtr` が <code>IORef Finalizers</code> への参照を保持している理由，というか，この <code>Finalizer</code> という名前の由来がよくわからないんですよね………．GCされるときにただ捨てられるものを指して <code>Finalizer</code> とはどういうことなのか．</div></div></div><div class="message event" id="message-1600945536.004600"><div class="content"><div class="summary"><div class="message__header user">gettaplacetogo</div><div class="message__timestamp date"><a class="date" href="#message-1600945536.004600">2020-09-24&nbsp;20:05:36 +0900</a></div></div><div class="message__body description">ただ捨てられる，ってのも変だな．“garbage collector (or compilers) should treat <code>ForeignPtrContents</code> specially” とか書いているのを見たことないので，ふっつーに扱われるんだろうな，と思っている，と言うのが正しい．</div></div></div><div class="message event" id="message-1600953249.007000"><div class="content"><div class="summary"><div class="message__header user">minorinoki_haskjp</div><div class="message__timestamp date"><a class="date" href="#message-1600953249.007000">2020-09-24&nbsp;22:14:09 +0900</a></div></div><div class="message__body description">最近追加されたコメントによると、ファイナライザの登録時に <code>mkWeak#</code> を使っているのがポイントのようですね <a href='https://gitlab.haskell.org/ghc/ghc/-/blob/a1f34d37b47826e86343e368a5c00f1a4b1f2bce/libraries/base/GHC/ForeignPtr.hs#L586'>https://gitlab.haskell.org/ghc/ghc/-/blob/a1f34d37b47826e86343e368a5c00f1a4b1f2bce/libraries/base/GHC/ForeignPtr.hs#L586</a></div></div></div><div class="message event" id="message-1600956771.007400"><div class="content"><div class="summary"><div class="message__header user">maoe</div><div class="message__timestamp date"><a class="date" href="#message-1600956771.007400">2020-09-24&nbsp;23:12:51 +0900</a></div></div><div class="message__body description">mkWeak#でweak pointerを作ってcapabilityごとに保持しているweak pointerのリストに追加します。GCは参照されていないweak pointerをリストアップしてscheduleFinalizersを呼び出し、リスト中のweak pointerのfinalizerを順次呼ぶという流れだと思います。Cのfinalizerはidle GCでも呼ばれていたような記憶があります。<br/>mkWeak#はrts/PrimOps.cmmのstg_mkWeakzhを、scheduleFinalizersはrts/Weak.cを見ると見つかります。</div></div></div><div class="message event" id="message-1600998780.007600"><div class="content"><div class="summary"><div class="message__header user">kazu</div><div class="message__timestamp date"><a class="date" href="#message-1600998780.007600">2020-09-25&nbsp;10:53:00 +0900</a></div></div><div class="message__body description">Finalizer とは、対象オブジェクトを捨てるために呼び出すコードのことですね。</div></div></div><div class="message event" id="message-1601021437.007800"><div class="content"><div class="summary"><div class="message__header user">naohaq</div><div class="message__timestamp date"><a class="date" href="#message-1601021437.007800">2020-09-25&nbsp;17:10:37 +0900</a></div></div><div class="message__body description">対象オブジェクトが何らかの(メモリ以外の)資源、例えばファイルハンドルを扱うものだった場合、GC でそのオブジェクトが捨てられるときにはファイルを閉じる必要があります。そのような処理をするのが finalizer です。</div></div></div><div class="message event" id="message-1601137541.012300"><div class="content"><div class="summary"><div class="message__header user">gettaplacetogo</div><div class="message__timestamp date"><a class="date" href="#message-1601137541.012300">2020-09-27&nbsp;01:25:41 +0900</a></div></div><div class="message__body description">そのようなものがFinalizerだと思っていたので，たかが <code>IORef</code> に入っている <code>IO ()</code> くらいのものをfinalizerと呼ぶのか，とずっと疑問だったのですが，あれユーザランドで勝手に弄る前提のものではなかったのですね！　まずそこにびっくりしていました．exportされてるから，てっきり <code>atomicModifyIORef</code> あたりでユーザが勝手に弄って良いものかと・・・．</div></div></div><div class="message event" id="message-1601302226.014500"><div class="content"><div class="summary"><div class="message__header user">gettaplacetogo</div><div class="message__timestamp date"><a class="date" href="#message-1601302226.014500">2020-09-28&nbsp;23:10:26 +0900</a></div></div><div class="message__body description"><code>mkWeak</code> あたりやっと読んできました。 <code>Weak</code> ってFinalizerをつけて作れるんですね。</div></div></div><div class="message event" id="message-1601302327.016300"><div class="content"><div class="summary"><div class="message__header user">gettaplacetogo</div><div class="message__timestamp date"><a class="date" href="#message-1601302327.016300">2020-09-28&nbsp;23:12:07 +0900</a></div></div><div class="message__body description">（というか型の機能が型自体になくて作成時にimplicitに付けるっていうのが面白い発想だなと思いました）</div></div></div><div class="message event" id="message-1601452112.016600"><div class="content"><div class="summary"><div class="message__header user">diohabara</div><div class="message__timestamp date"><a class="date" href="#message-1601452112.016600">2020-09-30&nbsp;16:48:32 +0900</a></div></div><div class="message__body description">@diohabara has joined the channel</div></div></div><div class="message event" id="message-1601519786.016800"><div class="content"><div class="summary"><div class="message__header user">agehara.dev</div><div class="message__timestamp date"><a class="date" href="#message-1601519786.016800">2020-10-01&nbsp;11:36:26 +0900</a></div></div><div class="message__body description">@agehara.dev has joined the channel</div></div></div><div class="message event" id="message-1601552292.017500"><div class="content"><div class="summary"><div class="message__header user">modasokun</div><div class="message__timestamp date"><a class="date" href="#message-1601552292.017500">2020-10-01&nbsp;20:38:12 +0900</a></div></div><div class="message__body description">@modasokun has joined the channel</div></div></div><div class="message event" id="message-1601689316.017800"><div class="content"><div class="summary"><div class="message__header user">dr.t.takahashi.0917</div><div class="message__timestamp date"><a class="date" href="#message-1601689316.017800">2020-10-03&nbsp;10:41:56 +0900</a></div></div><div class="message__body description">@dr.t.takahashi.0917 has joined the channel</div></div></div></div><div class="pager ui pagination menu"><a href="../../html/C5666B6BB/89.html" class="pager__previous item">Previous</a><a href="../../" class="pager__top item">Top</a></div></div></body></html>